---
title: "BMI Trends in Cebu"
author: "Remy Voloshchuk"
date: "`r Sys.Date()`"
html_document:
  toc: true
  toc_float: true
  toc_highlight: true
  number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F,include=T,eval=T,warning=F, message=F, cache=F)

library(dplyr)
library(psych)
library(tidyverse)
library(haven)
library(ggplot2)
library(knitr)
library(splines)
library(Ecdat)
library(tidymodels)
library(plotly)
library(quantreg)
library(kableExtra)
library(lme4)
library(lmerTest)
library(sjPlot)
library(sjmisc)
library(nlme)
library(tableone)
library(Hmisc)
library(sandwich)
library(lmtest)
library(boot)
library(table1)
library(stargazer)
library(jtools)
library(quantreg)
library(performance)
library(ggpubr)
library(broom.mixed)
library(gridExtra)

```

## Abstract {.tabset}

Objective: To assess the effect of distal variables representing the nutrition transition on young adults in a dynamic, urbanizing, and growing area in The Philippines; to test whether these variables played different roles in determining having relatively low, median, or high BMI; and to test whether these patterns differed by sex.

### import data

newid 10201847 was moved to correct age category at age 15 manually
Got urbindex from the urbindex file (urbindex.all) for consistency's sake, since I did not originally have anything beyond 2005.

```{r import, include=F}
df <- read_dta('/Users/rvolosh/Documents/Linda/cohortsobesity.dta')
  #moving the person to correct age category
df[df$newid=='10201847'&df$age==15,]$newagecat2 <- 16
# fizing on boy's age
df[df$newid==40020517 & df$age < 8 & df$age > 7,]$age <- 8.49416666666667

# importing data with more info about ages
analyze <- read_dta('/Users/rvolosh/Documents/Linda/cohorts_data_for_analysis(3).dta')

# pulling date of birth from '/Users/rvolosh/Documents/Linda/cebuheightlong.dta'
cebuheight <- read_dta('/Users/rvolosh/Documents/Linda/cebuheightlong.dta') 

# this database has only one id entrace per ID
allwealth <- read_dta('/Users/rvolosh/Documents/Linda/wealthallpc.dta')

# cebu - multiple ages
cebuwealth <- read_dta('/Users/rvolosh/Documents/Linda/wealth_datasheets/cebuwealth.dta')

# looking for files to pull the ids from
analyzewealthpc <- read_dta('/Users/rvolosh/Documents/Linda/wealthallpc.dta')

urbindex.all <- read_dta('/Users/rvolosh/Documents/Linda/urbindexwideallyears.dta')
```

``` {r get IDs, include=F}

cebuwealth2 <- cebuwealth %>% mutate(newid=uncchdid+40000000)

pc <- read_dta('/Users/rvolosh/Documents/Linda/cebupc.dta') %>% 
  select(-site) %>% mutate(newid=uncchdid+40000000)

df1 <- df[df$site==4 & !is.na(df$newid),] %>% mutate(uncchdid = newid - 40000000) %>% filter(!is.na(uncchdid)) %>%
  # making year bins to match with pc; all the .pc variables are from pc doc
  mutate(
    year = case_when(agecat==2 ~ 1986,
                     agecat==8 ~ 1991,
                     agecat %in% c(10,11,12) ~ 1994,
                     agecat %in% c(14,15,16) ~ 1998,
                     agecat %in% c(18,19) ~ 2002,
                     agecat==20 ~ 2005,
                     agecat==25 ~ 2009,
                     agecat==35 ~ 2018, .default = NA)
  ) %>%
  left_join(dplyr::rename(pc, pc.pc = pc, pc2.pc = pc2, pc3.pc = pc3, welath3q.pc = wealth3q) %>% select(-uncchdid), by = c('year','newid')) %>%
  left_join(pc, by=c('newid','uncchdid','year')) %>% mutate(survey=year)

```

```{r quantiling pc base.pc and urbinex, include=FALSE}

df2 <- df1 %>% group_by(site,year) %>% mutate(
  pc.q = ifelse(pc >= quantile(pc,na.rm=TRUE,2/3), 2, 
                ifelse(pc >= quantile(pc,na.rm=TRUE,1/3), 1,
                ifelse(pc < quantile(pc,na.rm=TRUE,1/3), 0,NA)))
) %>% 
  mutate(site = as.numeric(as.character(site))) %>%
  mutate(site = factor(site, levels = c(1,2,3,4,5))) %>%
  left_join(urbindex.all, by=c('uncchdid','year')) %>% mutate(
    urbindex.q=ifelse(urbindex<quantile(urbindex,1/3,na.rm=TRUE),0,
                           ifelse(urbindex<quantile(urbindex,2/3,na.rm=TRUE),1,
                                  ifelse(urbindex>=quantile(urbindex,2/3,na.rm=TRUE),2,NA)))
  ) %>% mutate(
    basepc.q=ifelse(basepc<quantile(basepc,1/3,na.rm=TRUE),0,
                           ifelse(basepc<quantile(basepc,2/3,na.rm=TRUE),1,
                                  ifelse(basepc>=quantile(basepc,2/3,na.rm=TRUE),2,NA)))
  ) %>% ungroup() %>% 
  mutate(
    # adding SES change variable between base and age 25
    pc.q.chg = ifelse(!is.na(basepc.q)&!is.na(pc.q)&agecat==22,paste0(basepc.q,pc.q),NA),
    pc.q.chg.25 = ifelse(!is.na(basepc.q)&!is.na(pc.q)&agecat==25,paste0(basepc.q,pc.q),NA)
  ) %>% group_by(newid) %>% 
  fill(pc.q.chg, .direction='updown') %>% fill(pc.q.chg.25, .direction='updown') %>% 
  ungroup()

```

### Longitudinal BMI & pc changes

- Changes in pc were calculated by subtracting the pc from the previous available point per individual ID and dividing it by the time over which the change in pc took place. If some times were missing, pc was filled in using points around it (e.g. if the person has pc information ate ages 2, 4, and 8, but not 6, with 2 being the baseline, 2 would be NA, 4 would be average yearly change in pc between ages 2 and 4, 6 and 8 both would be the average yearly change in pc between 4 and 8)

``` {r creating bmi change bins, include=T}

df3 <- df2 %>% filter(!is.na(age)) %>% 
  mutate(survey = case_when(!is.na(survey) ~ survey,
                            agecat==2 ~ 1986,
                            agecat==8 ~ 1991,
                            agecat==11 ~ 1994,
                            agecat==20 ~ 2005,
                            agecat==25 ~ 2009)) %>% group_by(newid) %>% 
  mutate(sex=factor(sex,levels=c(0,1))) %>% filter(!is.na(sex)) %>%
  group_by(newid) %>%
  arrange(newid,age) %>%
  mutate(pc.chg = ifelse(!is.na(lag(pc)), (pc - lag(pc))/(age-lag(age)), 
                         ifelse(!is.na(lag(lag(pc))), (pc - lag(lag(pc)))/(age-lag(lag(age))),
                                (pc - lag(lag(lag(pc))))/(age-lag(lag(lag(age))))))) %>%
  mutate(min.age = ifelse(age==min(age), 1, 0)) %>%
  fill(pc.chg, .direction='up') %>%
  ungroup() %>%
  mutate(pc.chg = ifelse(min.age==0,pc.chg,NA)) %>%
  
  # bmi change yearly
  group_by(newid) %>%
  arrange(newid,age) %>%
  mutate(bmic.chg.y = ifelse(!is.na(lag(bmic)), (bmic - lag(bmic))/(age-lag(age)), 
                         ifelse(!is.na(lag(lag(bmic))), (bmic - lag(lag(bmic)))/(age-lag(lag(age))),
                                (bmic - lag(lag(lag(bmic))))/(age-lag(lag(lag(age))))))) %>%
  mutate(min.age = ifelse(age==min(age), 1, 0)) %>%
  fill(bmic.chg.y, .direction='up') %>%
  
  # bmi change yearly as proportion of original bmi
  mutate(bmic.chg.yperc = ifelse(!is.na(lag(bmic)), (bmic - lag(bmic))/(age-lag(age))/lag(bmic), 
                         ifelse(!is.na(lag(lag(bmic))), (bmic - lag(lag(bmic)))/(age-lag(lag(age)))/lag(lag(bmic)),
                                (bmic - lag(lag(lag(bmic))))/(age-lag(lag(lag(age))))/lag(lag(lag(bmic)))))) %>%
  mutate(min.age = ifelse(age==min(age), 1, 0)) %>%
  fill(bmic.chg.yperc, .direction='up') %>%
  ungroup() %>%
  mutate(bmic.chg.yperc = ifelse(min.age==0,bmic.chg.yperc,NA))


```

### Incident OWOB & creating lagged variables

- df4 has lagged variables for wealth and urbanicity
- df4 has the owob variable
  - it is 0 if patient was lean and stayed lean or was owob and became lean
  - 1 if was lean and became owob
  - NA if was owob and stayed owob
  
``` {r lagged pred vars and modified edu, include=FALSE}

df4 <- df3 %>% filter(site==4) %>% 
  # adding urbindex from the urbindex.all file
  select(-urbindex) %>% left_join(urbindex.all, by=c('uncchdid', 'survey'='year')) %>%
  group_by(newid) %>%
  # adding basepc as pc from 1986
  mutate(
    pc=ifelse(year!=1986,pc,basepc),
    pc.q=ifelse(year!=1986,pc.q,basepc.q)
    ) %>%
  arrange(newid, age) %>%
  mutate(
    # lagged urbanicity index
    lag.urbindex = lag(urbindex),
    # lagged pc
    lag.pc = lag(pc),
    # change in pc (not yearly)
    pc.chg = pc - lag(pc),
    lag.pc.q = lag(pc.q),
    lag.pc.q.chg = lag(pc.q.chg),
    # change in pc yearly
    pc.chg.y = ifelse(!is.na(lag(pc)), (pc - lag(pc))/(age-lag(age)), 
                         ifelse(!is.na(lag(lag(pc))), (pc - lag(lag(pc)))/(age-lag(lag(age))),
                                (pc - lag(lag(lag(pc))))/(age-lag(lag(lag(age))))))) %>%
  mutate(min.age = ifelse(age==min(age), 1, 0)) %>%
  fill(pc.chg.y, .direction='up') %>%
  ungroup() %>%
  mutate(pc.chg.y = ifelse(min.age==0,pc.chg,NA)) %>% 
  select(-min.age) %>% group_by(newid) %>% arrange(newid, age) %>% mutate(
  owob = ifelse(age < 3 & bmi3cat>0,NA,
         ifelse(bmi3cat==0,0,
         ifelse(bmi3cat>0 & lag(bmi3cat)==0,1,NA)))
) %>% ungroup() %>% group_by(year) %>% mutate(
  # overall urbindex, not by year
  lag.urbindex.q.overall = ifelse(lag.urbindex<31,0,
                          ifelse(lag.urbindex<45,1,
                                 ifelse(!is.na(lag.urbindex),2,NA))),
  # urbindex by year
  lag.urbindex.q = ifelse(lag.urbindex<quantile(lag.urbindex, 1/3, na.rm=TRUE),0,
                          ifelse(lag.urbindex<quantile(lag.urbindex, 2/3, na.rm=TRUE),1,
                                 ifelse(!is.na(lag.urbindex),2,NA)))
) 

```

### Adding education variables

- df5 has education variables added

- z-scores were made for education. this variable is called gradecom.z
  - in 1998 the girls and the boys were contacted at different times, making the education of one a year later than the other, which is why in 1998, and only in 1998, the z-scores were calculated by sex
  - sex=NA were removed, because I checked and they were not in my main file, so I assumed they never participated in the study or dropped out before 1986
 
  - I am keeping maxgrade (variable denoting maximum grade complete by IC), because there are some discrepancies in the data (like grade 6 at one survey and grade 5 at the next). If I am ever to use this data with the children and see how they are doing in school, THIS NEEDS TO BE CLEANED. But not ow, because I am not using this data, and it does not affect my analysis or my results.
  
  - If in 2005, 2009, or 2018 gradecom is missing (gradecom I got from the gradecom05, etc.), I am applying the number from maxgrade
  - I am creating a categorical variable, called educat
    1. Less than high school - referent group
    2. HS grad
    3. Some college
    4. College grad
    
    
  - The above data was pulled from the "datasetforEHBpaper.dta" dataset.
  
For education, in 2009 there were 57 people in the 16 year group and 5 total with above 16 years of education(17, 18, 21, 22).
I just added them all to the 16 year group in the gradecom.z (z-score of education) variable, because that is 12 + 4, meaning they are getting some kind of graduate degree.

In 2018 education, there are 6 people in 18 years, and 1 in 19 years of education, so I am lumping them into 16.

``` {r adding edu info and making vars, include=TRUE}

# import education data
edu <- read_dta('/Users/rvolosh/Documents/Linda/datasetforEHBpaper.dta') %>% 
  select(uncchdid, sex, gradecom91, gradecom94, gradecom98, gradecom02, gradecom05, gradecom2007, gradecom2009, gradecom2018, 
         maxgrade, hsgrad, somecollege, collegegrad) %>%
  pivot_longer(cols = c(gradecom91, gradecom94, gradecom98, gradecom02, gradecom05, gradecom2007, gradecom2009, gradecom2018), names_to = 'surv.yr', values_to = 'gradecom') %>% mutate(
    yr = as.numeric(gsub('gradecom', '', surv.yr))
  ) %>% mutate(
    year = ifelse(yr < 100 & yr > 90, 
                  yr + 1900,
                  ifelse(yr < 100, 
                         yr + 2000, yr))) %>% 
  select(uncchdid, year, gradecom, sex, maxgrade, hsgrad, somecollege, collegegrad) %>% 
  # some of them have gradecom to a certain point, so I will fill it out for later
  # first filtering out the ones that don't have sex, as they are also missing from my main dataset
  filter(!is.na(sex)) %>% 
  # making gradecom2 to take care of gradecom.z outliers who have grad+ education
  mutate(gradecom2=ifelse(gradecom<17, gradecom, 16)) %>%
  group_by(year) %>% mutate(
    gradecom.z = (gradecom2 - mean(gradecom2, na.rm = TRUE))/sd(gradecom2, na.rm = TRUE)
    # fixing the fact that in 1998 girls and boys were done in two separate years
  ) %>% mutate(
    gradecom.z.q = ifelse(gradecom.z < quantile(gradecom.z, 1/3, na.rm=TRUE), 0,
                          ifelse(gradecom.z <= quantile(gradecom.z, 2/3, na.rm=TRUE), 1, 2))
  ) %>% group_by(year, sex) %>%
  mutate(gradecom.z1998 = (gradecom2 - mean(gradecom2, na.rm = TRUE))/sd(gradecom2, na.rm = TRUE)) %>%
  mutate(
    gradecom.z.q1998 = ifelse(gradecom.z1998 < quantile(gradecom.z1998, 1/3, na.rm=TRUE), 0,
                          ifelse(gradecom.z1998 <= quantile(gradecom.z1998, 2/3, na.rm=TRUE), 1, 2))
  ) %>%
  ungroup() %>%
  select(-gradecom2, -sex) %>%
  # combining the 1998 with the normal ones
  mutate(gradecom.z = ifelse(year==1998, gradecom.z1998, gradecom.z),
         gradecom.z.q = ifelse(year==1998, gradecom.z.q1998, gradecom.z.q)) %>% select(-gradecom.z1998, -gradecom.z.q1998)

df5 <- df4 %>% left_join(
  edu, by = c('uncchdid', 'year')) %>%
  mutate(uncchdid = case_when(!is.na(uncchdid) ~ uncchdid,
                   !is.na(newid) ~ newid-40000000, 
                   TRUE ~ NA)) %>%
  filter(!is.na(uncchdid)) %>%
  # creating education categorical variables
  # I am making less than high school the referent group because they were the most numerous
  mutate(
    educat = case_when(collegegrad==1 ~ 4, somecollege==1 ~ 3, hsgrad==1 ~ 2, TRUE ~ 1)
  ) %>%
  mutate(
    # making educat a categorical variable
    educat = factor(educat, levels = c(1, 2, 3, 4))
  ) %>%
  # filling in years of study for when they are missing, but only in 2002 onwards, because I am not using earlier data
  # I checked and saw that only some people in 1998 and 2009 were missing gradecom, so I will only fill in the 2009 ones.
  # They all had 11 as their max grade, which works, as they certainly were not still in school in 2009
  mutate(
    gradecom = case_when(survey==2009&is.na(gradecom) ~ maxgrade, TRUE ~ gradecom)
  )

# taking away year, because I renamed it to survey for subsequent datasets
df5 <- df5[,colnames(df5)[!(colnames(df5) %in% c("year"))]]

```

### Adding pregnancy and parity information

- df6 has pregnancy info and the BMI for those who are pregnant is assigned as 0

``` {r women preg info, include=TRUE}
# get the ones pergnant now, since they seem to be missing from my data...
ic0205 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/preg_inf/IC0205.dta') %>% select(
  uncchdid, icpreg02, icpreg05
) %>% pivot_longer(cols=c(icpreg02,icpreg05), names_to = 'survey', values_to = 'pregnow') %>%
  mutate(survey=as.numeric(gsub('icpreg', '20', survey))) %>% select(uncchdid, survey, pregnow)

ic0918 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/preg_inf/ic050918_Long.dta') %>% select(
  uncchdid, survey=year, pregnow
  ) %>% distinct(uncchdid, survey, pregnow) %>% filter(survey!=2009)

# this is just the 2009 info, because it is lacking from the other files
ic09 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/preg_inf/ANTHBP.dta') %>%
  mutate(pregnow=case_when(mospreg < 0 ~ 0, TRUE ~ 1)) %>%
  select(uncchdid, pregnow) %>% mutate(survey=2009) %>% select(uncchdid, survey, pregnow)

preg.now <- rbind(ic0205, ic0918, ic09) %>% filter(!is.na(pregnow))

# checking for the exact interview date
pregs1 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/preg files/pregsonly0218_interval.dta') %>%
  distinct() %>% # this one has interview dates starting in 2002 
  # fixing date survey (date interview does not match up to survey, fixing that)
  mutate(interview.year = as.numeric(str_extract(as.character(dateintvw), '20[0-9][0-9]'))) %>%
  mutate(
    survey = ifelse(interview.year %in% c(2002, 2005, 2009, 2018), interview.year,
                    # the remaining year was 2003, which would be the 2002 survey
                    ifelse(interview.year==2019, 2018, 2002))
  )

# gettin gnumber of kids had between surveys
pregs2018 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/preg files/pregsonly0218.dta') %>% mutate(
  # code all miscarriages as zero and all completed pregnancies as 1
  preg = ifelse(pregterm < 4, 1, 
                      ifelse(pregterm==5, 1,
                             ifelse(pregterm==4, 0, NA))), # there were no NAs, but keeping this here anyway
  # birthday of baby
  bday = as.Date(
    paste0(newday, '/', newmonth, '/', yearpreg), format = '%d/%m/%Y'
  )
) %>% 
  # remove all duplicate pregnancies, just in case
  distinct(uncchdid, bday, .keep_all = TRUE) %>%
  # remove all miscarriages from the preg file
  filter(preg==1) %>% 
  # make new pregord (num.preg.total) where we do not take into account miscarriage (only total completed pregnancies thus far)
  group_by(uncchdid) %>%
  arrange(bday) %>%
  mutate(
    num.preg.total = 1:n()
  ) %>% ungroup() %>%
  # make new pregord (num.preg.surv) where we do not take into account miscarriage (only completed pregnancies between surveys)
  group_by(uncchdid, survey) %>%
  arrange(bday) %>%
  mutate(
    num.preg.surv = 1:n()
  ) %>% mutate(
    num.preg.surv2 = max(num.preg.surv)
  ) %>% ungroup() %>%
  mutate(
    num.preg.surv = num.preg.surv2,
    bday = max(bday),
    num.preg.total=max(num.preg.total)
  ) %>% select(-num.preg.surv2) %>% 
  distinct(uncchdid, survey, num.preg.surv, .keep_all = TRUE) %>%
  mutate(
    # hdsurv = did mom have kids between this survey and last?
    hksurv = ifelse(num.preg.surv > 0, 1, 0)
  ) %>% ungroup() %>%
  group_by(uncchdid) %>% arrange(survey) %>%
  mutate(
    # num pregs per year
    #Infs from duplicates w latest pregnancy, so I will fill them in
    num.preg.surv.yr = num.preg.surv/(survey-Lag(survey, shift=1))
  ) %>% ungroup() %>% distinct(uncchdid, survey, num.preg.surv, .keep_all = TRUE)

# postpartum is 0 if woman was not pregnant or recently pregnant at the time
df6 <- df5 %>% left_join(pregs2018%>%select(uncchdid, survey, bday, num.preg.total, num.preg.surv, num.preg.surv.yr), by = c('uncchdid', 'survey')) %>%
  # adding who was pregnant at the time of interview
  left_join(preg.now, by=c('uncchdid', 'survey')) %>% mutate(
    pregnow = case_when(is.na(pregnow) ~ 0, .default = pregnow)
  ) %>% filter(!is.na(uncchdid)) %>%
  mutate(
    # assigning pregnant BMI as missing
    bmic = case_when(pregnow==1 ~ NA, .default = bmic),
    num.preg.surv=ifelse(!is.na(num.preg.surv), num.preg.surv, 0)
  )

no.inf6 <- df6[df6$sex==0,] %>% select(newid, survey, num.preg.surv.yr) %>%
  group_by(newid,survey) %>%
  filter(!is.infinite(num.preg.surv.yr)) %>% ungroup() %>% distinct(newid, survey, .keep_all = TRUE)

# here, the mo.pp is minimum in each survey (if had mult pregnancies, the latest postpartum)
df6.5 <- df6 %>% select(-num.preg.surv.yr) %>%
  left_join(no.inf6, by = c('newid', 'survey')) %>%
  distinct(uncchdid,survey,bday, .keep_all = TRUE) %>%
  # for modelling, adding 0 to num.preg.surv.yr instead of NA
  mutate(num.preg.surv.yr=ifelse(!is.na(num.preg.surv.yr), num.preg.surv.yr, 0))

```

### Descriptive stats

```{r descriptive stats 1, eval=FALSE, include=FALSE}

obescnts <- df6.5 %>% filter(!is.na(sex), !is.na(survey)) %>%
  group_by(sex, survey, bmi4cat, lag.pc.q, lag.urbindex.q, gradecom.z.q, owob) %>%
  dplyr::summarise(count = n()) %>%
  ungroup() %>%
  mutate(
    owob = factor(owob, levels=c('0', '1', 'NA')),
    sex = ifelse(sex==0,'Female ICs', 'Male ICs'),
    bmi4cat = factor(bmi4cat, levels=c('0', '1', '2', '3')),
    lag.pc.q = factor(lag.pc.q, levels=c('0', '1', '2')),
    lag.urbindex.q = factor(lag.urbindex.q, levels=c('0', '1', '2')),
    gradecom.z.q = factor(gradecom.z.q, levels=c('0', '1', '2'))
  ) %>% filter(survey < 2020)

ggplot(obescnts%>%mutate(bmi4cat=case_when(
  bmi4cat==0 ~ '<18.5', bmi4cat==1 ~'18.5 - 25', bmi4cat==2 ~ '25 - 30', bmi4cat==3 ~ '>30', .default = NA))%>%
    mutate(bmi4cat=factor(bmi4cat,levels=c('<18.5','18.5 - 25','25 - 30','>30')))%>%filter(!is.na(lag.pc.q)), 
  aes(x=lag.pc.q, y=count), col = "#023047") +
  geom_col(aes(fill=bmi4cat), position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_colour_discrete(aes(fill=bmi4cat), guide = "none") +
  scale_fill_manual(values = c("#06d6a0", "#ffd166", "#26547c", "#ef476f")) +
  facet_wrap(~survey) +
  ggtitle('Cebu BMI vs. Wealth by Survey Year') +
  labs(#caption='0 - underweight\n1 - normal weight\n2 - overweight\n3 - obese',
       fill = 'BMI (kg/m2)',
       x="Wealth Tertile", y="")

ggplot(obescnts%>%mutate(bmi4cat=case_when(
  bmi4cat==0 ~ '<18.5', bmi4cat==1 ~'18.5 - 25', bmi4cat==2 ~ '25 - 30', bmi4cat==3 ~ '>30', .default = NA))%>%
    mutate(bmi4cat=factor(bmi4cat,levels=c('<18.5','18.5 - 25','25 - 30','>30')))%>%filter(!is.na(lag.pc.q), sex==0), 
  aes(x=lag.pc.q, y=count), col = "#023047") +
  geom_col(aes(fill=bmi4cat), position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_colour_discrete(aes(fill=bmi4cat), guide = "none") +
  scale_fill_manual(values = c("#06d6a0", "#ffd166", "#26547c", "#ef476f")) +
  facet_wrap(~survey) +
  ggtitle('Women') +
  labs(#caption='0 - underweight\n1 - normal weight\n2 - overweight\n3 - obese',
       fill = 'BMI (kg/m2)',
       x="Wealth Tertile", y="")

ggplot(obescnts%>%mutate(bmi4cat=case_when(
  bmi4cat==0 ~ '<18.5', bmi4cat==1 ~'18.5 - 25', bmi4cat==2 ~ '25 - 30', bmi4cat==3 ~ '>30', .default = NA))%>%
    mutate(bmi4cat=factor(bmi4cat,levels=c('<18.5','18.5 - 25','25 - 30','>30')))%>%filter(!is.na(lag.pc.q), sex==1), 
  aes(x=lag.pc.q, y=count), col = "#023047") +
  geom_col(aes(fill=bmi4cat), position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  scale_colour_discrete(aes(fill=bmi4cat), guide = "none") +
  scale_fill_manual(values = c("#06d6a0", "#ffd166", "#26547c", "#ef476f")) +
  facet_wrap(~survey) +
  ggtitle('Men') +
  labs(#caption='0 - underweight\n1 - normal weight\n2 - overweight\n3 - obese',
       fill = 'BMI (kg/m2)',
       x="Wealth Tertile", y="")


```

``` {r descriptive stats for vars, eval=FALSE, include=FALSE}
# BMI and OWOB crossing stats
obescnts <- df6.5 %>% filter(!is.na(sex) & survey %in% c(2005, 2009, 2018)) %>%
  # filtering out the pregnant ones
  filter(!is.na(bmic) & !is.na(lag.pc.q) & !is.na(pc.q) & !is.na(lag.urbindex.q) & !is.na(urbindex.q) & !is.na(educat)) %>%
  group_by(sex, survey, bmi3cat, bmi4cat, lag.pc.q, pc.q, lag.urbindex.q, urbindex.q, educat, owob) %>%
  dplyr::summarise(count = n()) %>%
  ungroup() %>%
  mutate(
    owob = factor(owob, levels=c('0', '1', 'NA')),
    bmi3cat = factor(bmi3cat, levels=c('0', '1', '2')),
    bmi4cat = factor(bmi4cat, levels=c('0', '1', '2', '3')),
    lag.pc.q = factor(lag.pc.q, levels=c('0', '1', '2')),
    lag.urbindex.q = factor(lag.urbindex.q, levels=c('0', '1', '2')),
    educat = factor(educat, levels=c('1', '2', '3', '4'))
  )

bar.plot.func <- function(data, f.wrap, title) {
  ggplot(data%>%mutate(bmi4cat=case_when(
    bmi4cat==0 ~ '<18.5', bmi4cat==1 ~'18.5 - 25', bmi4cat==2 ~ '25 - 30', bmi4cat==3 ~ '>30', TRUE ~ NA),
    educat = case_when(educat == 1 ~ "Less than HS",
                       educat == 2 ~ "HS Grad",
                       educat == 3 ~ "Some College",
                       educat == 4 ~ "College Grad", TRUE ~ NA))%>%
      mutate(bmi4cat=factor(bmi4cat,levels=c('<18.5','18.5 - 25','25 - 30','>30')),
             educat = factor(educat, levels=c("Less than HS","HS Grad","Some College","College Grad"))), 
    aes(x=survey, y=count, col=bmi4cat)) +
    geom_col(aes(fill=bmi4cat), position = "fill") +
    scale_y_continuous(labels = scales::percent) +
    scale_colour_discrete(aes(fill=bmi4cat), guide = "none") +
    facet_wrap(as.formula(paste("~", f.wrap))) +
    ggtitle(title) +
    labs(fill = 'BMI (kg/m2)')
}

# WEALTH

# previous survey wealth tertiles
bar.plot.func(obescnts, 'lag.pc.q', 'BMI by HAI Tertile at Previous Survey')
# stratified by sex
bar.plot.func(obescnts%>%filter(sex==0 & !is.na(lag.pc.q)), 'lag.pc.q', 'Female BMI by HAI Tertile at Previous Survey')
bar.plot.func(obescnts%>%filter(sex==1 & !is.na(lag.pc.q)), 'lag.pc.q', 'Male BMI by HAI Tertile at Previous Survey')

# concurrent survey wealth tertiles
bar.plot.func(obescnts, 'pc.q', 'BMI by HAI Tertile')
# stratified by sex
bar.plot.func(obescnts%>%filter(sex==0 & !is.na(lag.pc.q)), 'pc.q', 'Female BMI by HAI Tertile')
bar.plot.func(obescnts%>%filter(sex==1 & !is.na(lag.pc.q)), 'pc.q', 'Male BMI by HAI Tertile')

# URBANICITY

# previous survey Urbanicity tertiles
bar.plot.func(obescnts, 'lag.urbindex.q', 'BMI by Urbanicity Tertile at Previous Survey')
# stratified by sex
bar.plot.func(obescnts%>%filter(sex==0 & !is.na(lag.urbindex.q)), 'lag.urbindex.q', 'Female BMI by Urbanicity Tertile at Previous Survey')
bar.plot.func(obescnts%>%filter(sex==1 & !is.na(lag.urbindex.q)), 'lag.urbindex.q', 'Male BMI by Urbanicity Tertile at Previous Survey')

# concurrent survey Urbanicity tertiles
bar.plot.func(obescnts, 'urbindex.q', 'BMI by Urbanicity Tertile')
# stratified by sex
bar.plot.func(obescnts%>%filter(sex==0 & !is.na(urbindex.q)), 'urbindex.q', 'Female BMI by Urbanicity Tertile')
bar.plot.func(obescnts%>%filter(sex==1 & !is.na(urbindex.q)), 'urbindex.q', 'Male BMI by Urbanicity Tertile')

# EDUCATION

# by education category
bar.plot.func(obescnts, 'educat', 'BMI by Education Category')
# stratified by sex
bar.plot.func(obescnts%>%filter(sex==0 & !is.na(educat)), 'educat', 'Female BMI by Education Category')
bar.plot.func(obescnts%>%filter(sex==1 & !is.na(educat)), 'educat', 'Male BMI by Education Category')


```

### Adding jobs

df7 is df6 with job info added

```{r input job files and merge, include=FALSE}

jobs2005 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/2005/TRACK05.DTA')
income2005 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/2005/INCOME.DTA')
employ2005 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/2005/employ.dta')
jobs2009f <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/2009/FemaleIC/Stata/ICWORK.dta') %>% mutate_all(as.numeric)
jobs2009m <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/2009/MaleIC/Stata/ICWORK.dta') %>% mutate_all(as.numeric)
jobs2012 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/INCOME2012.dta')
jobs2018 <- read_dta('/Users/rvolosh/Documents/Papers/Cebu incident obesity/job files/2018/IC only.dta')

# merging male and female 2009
jobs2009 <- rbind(jobs2009f, jobs2009m)

```

Variable of interest names:
- mainpos = position primarily working in in main job
  - I am putting sitting and squatting in together into one variable
  - I am putting standing and standing + bending over together as well
  - Three main categories - sitting most of the time, standing most of the time, and moving most of the time
- mainexe, secexer = does main job require physical exertion? If yes, what kind
  - the vast majority were in the 0 category
  - dividing into:
    - no exertion (self-evident) - 0, -9 (N/A)
    - light exertion (e.g. sweeping, carrying a child) - 2, 3, 6, 9, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 25, 29
    - heavy exertion (e.g. bending iron grills, lifting/carrying heavy objects) - 1, 4, 5, 7, 8, 10, 14, 23, 24, 26, 27, 28
    
Since we did not have the exertion variable in the 2009 job data, I will use pos, but before using it, I will test it in 2005, to see:
  a) how well it correlates with exertion
  b) if it changes my results
    I. how does it affect our main variables of interest?
    II. is the coefficient itself now different?
    
In 2018, there is no position variable to double-check with.
    
```{r preparing to make df cebu7, include=FALSE}
# adding if employed or not and income for 2005 and 2012 to use as pred of OWOB in 2009 and 2018.
employ2005.2 <- select(employ2005, uncchdid, mainjob, secjob, mainpos, mainexe, mainearn, mainhrs, mainday, secjob, secposi, secexer, secearn, sechrs, secdays, joborder) %>% 
  as.data.frame() %>%
  # getting the most recent job
  group_by(uncchdid) %>%
  arrange(desc(joborder)) %>%
  distinct(uncchdid, .keep_all = TRUE) %>%
  ungroup()

# preparing the 2009 jobs file to be added
jobs2009.2 <- select(jobs2009, uncchdid, mainjob, maindo, mainhrs, secnjob, secnhrs, secndo) %>% as.data.frame()

# preparing the 2018 jobs file to be added
jobs2018.2 <- select(jobs2018, uncchdid,
                     # main job past 12 mo
                     cmainjob, cnamemain, cmainphysical, cmainhrday, cmaindaywk, cmainearn,
                     # total days worked per week
                     daywork, 
                     # second job
                     csecjob, csecphysical, csecdaywk, csechrday, csecearn,
                     # are you currently working and referring to main job - did it end?
                     worknow, cmainendmo, csecendmo, 
                     # money earned by other means and var for mi
                     othermeans, amountps, decidespend) %>% as.data.frame() %>% mutate_all(as.numeric)
```

```{r making df cebu7, include=FALSE}
df7 <- left_join(df6, employ2005.2, by='uncchdid') %>% mutate_all(as.character) %>% mutate_all(as.numeric) %>% mutate(
  # does IC have first job?
    employed = case_when(survey==2005 & mainjob>0 ~ 1,
                         survey==2005 ~ 0, TRUE ~ NA),
    # does IC have second job?
    employed2 = case_when(survey==2005 & secjob>0 ~ 1,
                          survey==2005 ~ 0, TRUE ~ NA),
    mainearn.weekly = case_when(survey==2005 & mainearn<=0 ~ 0,
                                survey==2005 ~ mainearn*mainday, 
                                TRUE ~ NA),
    secearn.weekly = case_when(survey==2005 & secearn<=0 ~ 0,
                               survey==2005 ~ secearn*secdays,
                               TRUE ~ NA),
    # 3 is squatting and 6 + are combinations
    mainpos2 = case_when(survey==2005 & mainpos %in% c(-9, 1, 3) ~ 0,
                         !is.na(survey==2005 & mainpos) ~ 1, TRUE ~ 0),
    secpos2 = case_when(survey==2005 & secposi %in% c(-9, 1, 3) ~ 0,
                        !is.na(survey==2005 & secposi) ~ 1, TRUE ~ 0),
    # binary exertion variable
    mainexebi = case_when(survey==2005 & mainexe>0 ~ 1, survey==2005 & mainexe<=0 ~ 0, 
                          survey==2005 ~ 0, TRUE ~ NA),
    secexebi = case_when(survey==2005 & secexer>0 ~ 1, survey==2005 & secexer<=0 ~ 0, 
                          survey==2005 ~ 0, TRUE ~ NA),
    # categorising exertion as none (0), light (1), and heavy (2)
    mainexecat = case_when(survey==2005 & mainexe %in% c(-9,0) ~ 0,
                           survey==2005 & mainexe %in% c(2, 3, 6, 9, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 25, 29) ~ 1,
                           survey==2005 & mainexe %in% c(1, 4, 5, 7, 8, 10, 14, 23, 24, 26, 27, 28) ~ 2, 
                           survey==2005 ~ 3, TRUE ~ NA),
    secexecat = case_when(survey==2005 & secexer %in% c(-9,0) ~ 0,
                           survey==2005 & secexer %in% c(2, 3, 6, 9, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 25, 29) ~ 1,
                           survey==2005 & secexer %in% c(1, 4, 5, 7, 8, 10, 14, 23, 24, 26, 27, 28) ~ 2, 
                          survey==2005 ~ 3, TRUE ~ NA),
    # getting total weekly hrs
    maintotwk = case_when(survey==2005 & mainhrs>0 & mainday>0 ~ mainhrs, 
                          survey==2005~0, TRUE ~ NA),
    sectotwk = case_when(survey==2005 & sechrs>0 & secdays>0 ~ sechrs, 
                         survey==2005~0, TRUE ~ NA),
    wrktotwk = case_when(survey==2005 & mainhrs>0 & mainday>0 & sechrs>0 & secdays>0 ~ mainhrs + sechrs, 
                         survey==2005 & mainhrs>0 & mainday>0 ~ mainhrs, 
                         survey==2005 ~ 0, TRUE ~ NA)
  ) %>% mutate(
    # total the hours the person was exerting themselves (no matter if main or second job)
    totposbi = case_when(mainpos2 > 0 | secpos2 > 0 ~ 1,
                         mainpos2 == 0 & secpos2 == 0 ~ 0, TRUE ~ NA),
    totposhr = case_when(mainpos2 > 0 & secpos2 > 0 ~ wrktotwk,
                         mainpos2 > 0 & secpos2 == 0 ~ maintotwk,
                         mainpos2 == 0 | secpos2 > 0 ~ sectotwk,
                         mainpos2 == 0 | secpos2 == 0 ~ 0, TRUE ~ NA),
    totexebi = case_when(mainexecat > 0 | secexecat > 0 ~ 1,
                         mainexecat == 0 & secexecat == 0 ~ 0, TRUE ~ NA),
    totexehr = case_when(mainexecat > 0 & secexecat > 0 ~ wrktotwk,
                         mainexecat > 0 & secexecat == 0 ~ maintotwk,
                         mainexecat == 0 | secexecat > 0 ~ sectotwk,
                         mainexecat == 0 | secexecat == 0 ~ 0, TRUE ~ NA),
  ) %>%
  # remove the columns with the same names as the 2005 file
  select(-mainjob, -secjob, -mainhrs, -sechrs) %>%
  # adding the 2009 jobs data file
  left_join(jobs2009.2, by='uncchdid') %>%
  mutate(
    # is IC employed?
    employed = case_when(survey==2009 & mainjob>0 ~ 1,
                         survey==2009 ~ 0, TRUE ~ employed),
    # does IC have second job?
    employed2 = case_when(survey==2009 & secnjob>0 ~ 1,
                          survey==2009 ~ 0, TRUE ~ employed2),
    mainpos2 = case_when(survey==2009 & maindo %in% c(1, 2, 5, 6) ~ mainpos,
    # modelling the non-working people as 1 (sitting) referent value
                         survey==2009 & maindo == -9 ~ 1,
                         survey==2009 & maindo == 4 ~ 2,
                         survey==2009 & maindo == 3 ~ 1, 
    # coding a mixed activity as 2, recognising that it may misclassify some people
                         survey==2009 & maindo<0 ~ 2, TRUE ~ mainpos2),
    secpos2 = case_when(survey==2009 & secndo %in% c(1, 2, 5, 6) ~ secndo,
                        survey==2009 & secndo == -9 ~ 1,
                        survey==2009 & secndo == 4 ~ 2,
                        survey==2009 & secndo == 3 ~ 1, 
    # coding a mixed activity as 2, recognising that it may misclassify some people
                        survey==2009 ~ 2, TRUE ~ secpos2),
    # modelling non-working as working 0 hours
    maintotwk = case_when(survey==2009&mainhrs==-9 ~ 0,
                          survey==2009 ~ mainhrs, TRUE ~ maintotwk),
    sectotwk = case_when(survey==2009&secnhrs>0 ~ secnhrs, 
                         survey==2009 ~ 0, TRUE ~ sectotwk),
    wrktotwk = case_when(survey==2009&secnhrs>0 ~ mainhrs + secnhrs, 
                         survey==2009&mainhrs>0 ~ mainhrs, 
                         survey==2009 ~ 0, TRUE ~ wrktotwk)
    ) %>% mutate(
    # total the hours the person was exerting themselves (no matter if main or second job)
    totposbi = case_when(survey==2009 & mainpos2 > 1 | secpos2 > 1 ~ 1,
                         survey==2009 & mainpos2 == 1 & secpos2 == 1 ~ 0, TRUE ~ totposbi),
    totposhr = case_when(survey==2009 & mainpos2 > 1 & secpos2 > 1 ~ wrktotwk,
                         survey==2009 & mainpos2 > 1 & secpos2 == 1 ~ maintotwk,
                         survey==2009 & mainpos2 == 1 | secpos2 > 1 ~ sectotwk,
                         survey==2009 & mainpos2 == 1 | secpos2 == 1~ 0, TRUE ~ totposhr)
    ) %>%
  left_join(jobs2018.2, by='uncchdid') %>%
  mutate(
    employed = case_when(survey==2018 & cmainjob==1 & cmainendmo == -9 ~ 1,
                         survey==2018 ~ 0, TRUE ~ employed),
    employed2 = case_when(survey==2018 & csecjob==1 & csecendmo == -9 ~ 1,
                         survey==2018 ~ 0, TRUE ~ employed2),
    maintotwk = case_when(survey==2018 & cmainhrday>0 & cmaindaywk>0 ~ cmainhrday*cmaindaywk,
                          survey==2018 ~ 0, TRUE ~ maintotwk),
    sectotwk = case_when(survey==2018 & csechrday>0 & csecdaywk>0 ~ csechrday*csecdaywk,
                          survey==2018 ~ 0, TRUE ~ sectotwk),
    wrktotwk = case_when(survey==2018 & cmainhrday>0 & cmaindaywk>0 & csechrday>0 & csecdaywk>0 ~ cmainhrday*cmaindaywk+csechrday*csecdaywk,
                         survey==2018 & cmainhrday>0 & cmaindaywk>0 ~ cmainhrday*cmaindaywk,
                         survey==2018 ~ 0, TRUE ~ wrktotwk),
    # binary exertion variable; 2 is not working
    mainexebi = case_when(survey==2018&cmainphysical>0 ~ 1, survey==2018&cmainphysical<=0 ~ 0, 
    # making the exertion variable 0 for the people who were not working
    # because the employed/unemployed var already has the info about them,
    # so we are not actually treating them as if they were the same as 
    # sedentary workers
                          survey==2018 ~ 0, TRUE ~ mainexebi),
    secexebi = case_when(survey==2018&csecphysical>0 ~ 1, survey==2018&csecphysical<=0 ~ 0, 
                          survey==2018 ~ 0, TRUE ~ secexebi)
  ) %>%
    # make them into categorical variables
  mutate(
    employed = factor(employed, levels=c(0,1)),
    employed2 = factor(employed2, levels=c(0,1)),
    mainexebi = factor(mainexebi, levels=c(0,1)),
    secexebi = factor(secexebi, levels=c(0,1)),
    mainexecat = factor(mainexecat, levels=c(0,1,2)),
    secexecat = factor(secexecat, levels=c(0,1,2))
  ) %>%
  # total the hours the person was exerting themselves (no matter if main or second job)
  mutate(
    totexebi = case_when(survey==2018 & mainexebi == 1 | secexebi == 1 ~ 1, 
                         survey==2018 & mainexebi == 0 & secexebi == 0 ~ 0, TRUE ~ totexebi),
    totexehr = case_when(survey==2018 & mainexebi == 1 & secexebi == 1 ~ wrktotwk,
                         survey==2018 & mainexebi == 1 & secexebi == 0 ~ maintotwk,
                         survey==2018 & mainexebi == 0 & secexebi == 1 ~ sectotwk,
                         survey==2018 & mainexebi == 0 & secexebi == 0 ~ 0, TRUE ~ totexehr)
    ) %>%
  # scaling urbindex by ten
  mutate(urbindex10 = urbindex/10,
         lag.urbindex10 = lag.urbindex/10) %>%
  # creating z-scores for urbindex
  group_by(survey) %>%
  mutate(z.lag.urb = (lag.urbindex - mean(lag.urbindex, na.rm = TRUE))/sd(lag.urbindex, na.rm = TRUE)) %>% ungroup %>%
  # mutating earn variables; cmainearn is per day, cmain/secdaywork; mainearn 2005 also per day; no income 2009
  mutate(
    totearn = case_when(survey==2005 & mainearn > 0 & secearn > 0 ~ mainearn*mainday + secearn*secdays,
                        survey==2005 & mainearn > 0 ~ mainearn*mainday,
                        survey==2005 ~ 0, 
                        survey==2018 & cmainearn > 0 & csecearn > 0 ~ cmainearn*cmaindaywk + csecearn*csecdaywk,
                        survey==2018 & cmainearn > 0 ~ cmainearn*cmaindaywk,
                        survey==2018 ~ 0, TRUE ~ NA
    )
  ) %>%
  # multiply totposhr by ten to make it per ten hours a day to make the coeffs more visible
  mutate(
    totexehr10 = totexehr/10,
    totposhr10 = totposhr/10,
    # adding a common proxy variable to match 2005, 2009, and 2018 surveys
    exertion.adj = case_when(survey == 2009 ~ totposhr, TRUE ~ totexehr),
  ) %>%
  # creating z-scores
  group_by(sex, survey) %>%
  mutate(
    z.exert = (exertion.adj - mean(exertion.adj, na.rm = TRUE))/sd(exertion.adj, na.rm = TRUE)
  ) %>% ungroup()

# factor educat (education category)
df7$educat <- factor(df7$educat, levels = c(1, 2, 3, 4))

```

### Tables 1, 2a, and 2b

#### Table 1: Participant Characteristics 

```{r table1, eval=TRUE, include=TRUE}

label(df7$sex) <- 'Sex'
label(df7$educat) <- 'Education'
label(df7$lag.pc) <- 'Household\nasset index'
label(df7$pc) <- 'Current household\nasset index'
label(df7$lag.urbindex) <- 'Urbanicity Index'
label(df7$urbindex) <- 'Current\nUrbanicity Index'
label(df7$bmic) <- 'BMI'
label(df7$bmi3cat) <- 'BMI Category'
label(df7$num.preg.surv) <- 'Parity'
label(df7$totexehr10) <- 'Hours exertion (10)'
label(df7$exertion.adj) <- 'Exertion\nat work (hr)'
label(df7$age) <- 'Age (yr)'

my.render.cont <- function(x) {
    with(stats.default(x), 
         c("",
           
          "Mean (SD)" = sprintf("%s (%s)",
                                round_pad(MEAN, 2),
                                round_pad(SD, 2)))
    )
}

df8 <- df7 %>% mutate(
  educat = factor(educat, levels = c(1,2,3,4), labels=c('Less than high school', 'High school', 'Some college', 'College')),
  employed = factor(employed, levels = c(1,0), labels = c('Employed', 'Unemployed')))


label(df8$educat) <- 'Education'
label(df8$employed) <- 'Employment'

# Table 1
table1(~ age + lag.pc + lag.urbindex + educat +  employed + num.preg.surv + bmic | factor(sex, levels=c(0,1), labels=c('Female','Male')) + survey,
       data=df8[df8$survey%in%c(2005,2009,2018),], overall=F,
       footnote='Table 1: Household asset index was calculated using principal component analysis. Urbanicity index is a composite score of amenities associated with urbanisation. Household asset and urbanicity indeces are lagged. These two variables were taken from the previous survey. Education represents highest educational level attained at the time of survey.', render.continuous=my.render.cont)

```

#### Table 2

```{r table2, eval=TRUE, include=TRUE}
# Table 2
table1(~ lag.pc + lag.urbindex + educat + bmic | survey + factor(bmi3cat, levels=c(0,1,2), labels=c('Normal','Overweight','Obese')),
       data=df7[df7$sex==0&df7$survey%in%c(2005,2009,2018),], caption='Descriptive Statistics: Females', overall=F,
       footnote='Household asset index was calculated using principal component analysis. Urbanicity index is a composite score of amenities associated with urbanisation. These two variables were taken from the previous survey. Education levels are the following: 1 - Less than HS, 2 - HS Grad, 3 - Some College, 4 - College Grad.', render.continuous=my.render.cont)

table1(~ lag.pc + lag.urbindex + educat + bmic | survey + factor(bmi3cat, levels=c(0,1,2), labels=c('Normal','Overweight','Obese')),
       data=df7[df7$sex==1&df7$survey%in%c(2005,2009,2018),], caption='Descriptive Statistics: Males', overall=F,
       footnote='Household asset index was calculated using principal component analysis. Urbanicity index is a composite score of amenities associated with urbanisation. These two variables were taken from the previous survey. Education levels are the following: 1 - Less than HS, 2 - HS Grad, 3 - Some College, 4 - College Grad.', render.continuous=my.render.cont)

```


### Sensitivity Analyses {.tabset .tabset-fade .tabset-pills}

#### Testing if pregnancy interactions are necessary

- Generally speaking, the less pregnancies the woman has since the last survey, the more likely she is to be employed.
- Being unemployed when one does not have children is different from being unemployed while taking care of small children, as it represents different levels of physical exertion.
- I propose, for women, to interact num.preg.surv with employment binary variable. Since I am not running a longitudinal model, but instead I am looking at cross-sections, I will not be using the num.pregs.surv.yr (average number of pregnancies per survey year), since the time between the surveys was the same for all the women.

Testing if pregnancy interactions are necessary

```{r pregs lrtest, include=TRUE}

lr.prep <- function(year, tau, pos=FALSE) {
  data1 <- df7 %>% filter(sex==0) %>% filter(survey==year)
  
  if (pos==TRUE) {
    data1 <- data1 %>% select(-totexehr10) %>% rename(totexehr10 = totposhr10)
  }
  
  test0 <- rq(bmic ~ educat + lag.pc + lag.urbindex + employed + num.preg.surv + totexehr10,
            data=data1, tau=c(tau))
  
  test1 <- rq(bmic ~ educat + lag.pc*num.preg.surv + lag.urbindex + employed + totexehr10,
            data=data1, tau=c(tau))
  
  results <- lrtest(test0, test1)
  return(results)
}

lr.prep(2005, 0.25) %>% cbind(Model = c('Without interaction','With interaction')) %>% 
  dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2005<br>Quantile 0.25", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2005, 0.50) %>% cbind(Model = c('Without interaction','With interaction')) %>% dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2005<br>Quantile 0.50", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2005, 0.75) %>% cbind(Model = c('Without interaction','With interaction')) %>% dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2005<br>Quantile 0.75", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2009, 0.25, pos=TRUE) %>% cbind(Model = c('Without interaction','With interaction')) %>% 
  dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2009<br>Quantile 0.25", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2009, 0.50, pos=TRUE) %>% cbind(Model = c('Without interaction','With interaction')) %>% dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2009<br>Quantile 0.50", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2009, 0.75, pos=TRUE) %>% cbind(Model = c('Without interaction','With interaction')) %>% dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2009<br>Quantile 0.75", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")


lr.prep(2018, 0.25) %>% cbind(Model = c('Without interaction','With interaction')) %>% 
  dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2018<br>Quantile 0.25", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2018, 0.50) %>% cbind(Model = c('Without interaction','With interaction')) %>% dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2018<br>Quantile 0.50", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

lr.prep(2018, 0.75) %>% cbind(Model = c('Without interaction','With interaction')) %>% dplyr::select(Model, everything()) %>% mutate(
    across(c(LogLik, Chisq, `Pr(>Chisq)`), ~ sprintf("%0.3f", .x)),
    across(where(is.character), ~ ifelse(str_squish(.) == "NA", "", .))
    ) %>% kbl(caption = "Likelihood Ratio Test Results<br>2018<br>Quantile 0.75", align=c('l','r','r','r','r','r')) %>% kable_classic(full_width = F, html_font = "Cambria")

```

Based on the results above, I should interact asset index with the number of pregnancies completed between the surveys. Though it is not the focus of my paper, it represents a real biological variable - maternal depletion vs. weight gain associated with pregnancy in settings of abundance.

#### Testing likelihood of being in the sample

People were not in the survey for the following reasons:
1. Pregnancy
2. Refusal
3. Death
4. Relocation

People who relocated (for example, moved abroad) were disproportionately better off. We cannot say for sure that the main characteristics of our sample were the same in all surveys, but, due to the variety of reasons for not being in the survey, we should test what made them more or less likely to be in the sample.

```{r testing likelihood of remaining in the sample, results='asis', include = TRUE}

df8.1986 <- df7[df7$survey==1986,]$uncchdid
df8.2002 <- df7[df7$survey==2002,]$uncchdid
df8.2005 <- df7[df7$survey==2005,]$uncchdid
df8.2009 <- df7[df7$survey==2009,]$uncchdid
df8.2018 <- df7[df7$survey==2018,]$uncchdid

df8 <- df7 %>% mutate(
  pres86 = case_when(uncchdid %in% df8.1986 ~ 1, TRUE ~ 0),
  pres02 = case_when(uncchdid %in% df8.2002 ~ 1, TRUE ~ 0),
  pres05 = case_when(uncchdid %in% df8.2005 ~ 1, TRUE ~ 0),
  pres09 = case_when(uncchdid %in% df8.2009 ~ 1, TRUE ~ 0),
  pres18 = case_when(uncchdid %in% df8.2018 ~ 1, TRUE ~ 0)
)

# women

# print("testing how likely someone present in 2005 was to also be present in 2009 - WOMEN")
tw9 <- glm(pres09 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

# print("testing how likely someone present in 2005 was to also be present in 2009 edu - WOMEN")
ew9 <- glm(pres09 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

# print("testing how likely someone present in 2005 was to also be present in 2009 HAI - WOMEN")
pw9 <- glm(pres09 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

# print("testing how likely someone present in 2005 was to also be present in 2009 urbanicity - WOMEN")
uw9 <- glm(pres09 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

stargazer(tw9, ew9, pw9, uw9,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2009 if present in 2005', 
          dep.var.caption = '<b>Female ICs</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Education<b/>', '<b>HAI</b>', '<b>Urbanicity</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

# print("testing how likely someone present in 2005 was to also be present in 2018 - WOMEN")
tw18 <- glm(pres18 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

# print("testing how likely someone present in 2005 was to also be present in 2018 edu - WOMEN")
ew18 <- glm(pres18 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

# print("testing how likely someone present in 2005 was to also be present in 2018 HAI - WOMEN")
pw18 <- glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

# print("testing how likely someone present in 2005 was to also be present in 2018 urbanicity - WOMEN")
uw18 <- glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

stargazer(tw18, ew18, pw18, uw18,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2018 if present in 2005', 
          dep.var.caption = '<b>Female ICs</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Education<b/>', '<b>HAI</b>', '<b>Urbanicity</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

print("testing how likely someone present in 2005 was to also be present in 2009 - MEN")
glm(pres09 ~ lag.pc + lag.urbindex + educat + employed + totexehr,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

print("testing how likely someone present in 2005 was to also be present in 2009 edu - MEN")
glm(pres09 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

print("testing how likely someone present in 2005 was to also be present in 2009 HAI - MEN")
glm(pres09 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

print("testing how likely someone present in 2005 was to also be present in 2009 urbanicity - MEN")
glm(pres09 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

print("testing how likely someone present in 2005 was to also be present in 2018 - MEN")
glm(pres18 ~ lag.pc + lag.urbindex + educat + employed + totexehr,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

print("testing how likely someone present in 2005 was to also be present in 2018 edu - MEN")
glm(pres18 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()
print("testing how likely someone present in 2005 was to also be present in 2018 HAI - MEN")
glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

print("testing how likely someone present in 2005 was to also be present in 2018 urbanicity - MEN")
glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit')) %>% summary()

# 2009 --> 2018

tw918 <- glm(pres18 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2009 & df8$sex==0,],
    family=binomial(link='logit'))

ew918 <- glm(pres18 ~ educat,
    data = df8[df8$survey==2009 & df8$sex==0,],
    family=binomial(link='logit'))

pw918 <- glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2009 & df8$sex==0,],
    family=binomial(link='logit'))

uw918 <- glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2009 & df8$sex==0,],
    family=binomial(link='logit'))

stargazer(tw918, ew918, pw918, uw918,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2018 if present in 2009', 
          dep.var.caption = '<b>Female ICs</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Education<b/>', '<b>HAI</b>', '<b>Urbanicity</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009to18.doc')



# non-preg only to see if it evens out the bias

df8.2005 <- df7[df7$survey==2005 & !is.na(df7$bmic),]$uncchdid
df8.2009 <- df7[df7$survey==2009 & !is.na(df7$bmic),]$uncchdid
df8.2018 <- df7[df7$survey==2018 & !is.na(df7$bmic),]$uncchdid

df8 <- df7 %>% mutate(
  pres05 = case_when(uncchdid %in% df8.2005 ~ 1, TRUE ~ 0),
  pres09 = case_when(uncchdid %in% df8.2009 ~ 1, TRUE ~ 0),
  pres18 = case_when(uncchdid %in% df8.2018 ~ 1, TRUE ~ 0)
)

# 2005 --> 2009, preg excluded
tw9p <- glm(pres09 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

ew9p <- glm(pres09 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

pw9p <- glm(pres09 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

uw9p <- glm(pres09 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

stargazer(tw9, tw9p, ew9, ew9p, pw9, pw9p, uw9, uw9p,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2009 if present in 2005', 
          dep.var.caption = '<b>Excluding pregnant vs. not</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Full model (np)</b>', '<b>Education<b/>', '<b>Education (np)<b/>', '<b>HAI</b>', '<b>HAI (np)</b>', '<b>Urbanicity</b>', '<b>Urbanicity (np)</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*<br>np - no pregnant (pregnant female ICs excluded)', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

# 2005 --> 2018 preg excluded
tw18p <- glm(pres18 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

ew18p <- glm(pres18 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

pw18p <- glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

uw18p <- glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

stargazer(tw18, tw18p, ew18, ew18p, pw18, pw18p, uw18, uw18p,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2018 if present in 2005', 
          dep.var.caption = '<b>Excluding pregnant vs. not</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Full model (np)</b>', '<b>Education<b/>', '<b>Education (np)<b/>', '<b>HAI</b>', '<b>HAI (np)</b>', '<b>Urbanicity</b>', '<b>Urbanicity (np)</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*<br>np - no pregnant (pregnant female ICs excluded)', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

# 2009 --> 2018 preg excluded
tw918p <- glm(pres18 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2009 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

ew918p <- glm(pres18 ~ educat,
    data = df8[df8$survey==2009 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

pw918p <- glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2009 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

uw918p <- glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2009 & df8$sex==0 & !is.na(df8$bmic),],
    family=binomial(link='logit'))

stargazer(tw918, tw918p, ew918, ew918p, pw918, pw918p, uw918, uw918p,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2018 if present in 2009', 
          dep.var.caption = '<b>Excluding pregnant vs. not</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Full model (np)</b>', '<b>Education<b/>', '<b>Education (np)<b/>', '<b>HAI</b>', '<b>HAI (np)</b>', '<b>Urbanicity</b>', '<b>Urbanicity (np)</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*<br>np - no pregnant (pregnant female ICs excluded)', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009to2018.doc')


# men 

# 2005 --> 2018
tm9 <- glm(pres09 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

em9 <- glm(pres09 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

pm9 <- glm(pres09 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

um9 <- glm(pres09 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

stargazer(tm9, em9, pm9, um9,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2009 if present in 2005', 
          dep.var.caption = '<b>Male ICs</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Education<b/>', '<b>HAI</b>', '<b>Urbanicity</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

# 2005 --> 2018
tm18 <- glm(pres18 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

em18 <- glm(pres18 ~ educat,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

pm18 <- glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

um18 <- glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2005 & df8$sex==1,],
    family=binomial(link='logit'))

stargazer(tm18, em18, pm18, um18,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2018 if present in 2005', 
          dep.var.caption = '<b>Male ICs</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Education<b/>', '<b>HAI</b>', '<b>Urbanicity</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

# 2009 --> 2018
tm918 <- glm(pres18 ~ lag.pc + lag.urbindex + educat + employed,
    data = df8[df8$survey==2009 & df8$sex==1,],
    family=binomial(link='logit'))

em918 <- glm(pres18 ~ educat,
    data = df8[df8$survey==2009 & df8$sex==1,],
    family=binomial(link='logit'))

pm918 <- glm(pres18 ~ lag.pc,
    data = df8[df8$survey==2009 & df8$sex==1,],
    family=binomial(link='logit'))

um918 <- glm(pres18 ~ lag.urbindex,
    data = df8[df8$survey==2009 & df8$sex==1,],
    family=binomial(link='logit'))

stargazer(tm918, em918, pm918, um918,
          type='html',
          digits = 3, 
          title = 'Coefficient estimates from a linear models testing likelihood<br>of being in the sample in 2018 if present in 2009', 
          dep.var.caption = '<b>Male ICs</b>',
          style = 'default', 
          column.labels = c('<b>Full model</b>', '<b>Education<b/>', '<b>HAI</b>', '<b>Urbanicity</b>'), 
          dep.var.labels = '', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HAI', 'Urbanicity index', 'HS Grad', 'Some College', 'College Grad', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009to18.doc')



```

Confirmed that, in general, richer and/or more urbanized people leave.

#### Models for women {.tabset .tabset-fade .tabset-pills}

```{r women models with interactions, include=TRUE}

# women models with employment
rqfit.f1.2005 <- rq(bmic ~ educat + lag.pc*num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=seq(.1,.9,.1))
summary(rqfit.f1.2005, se='boot')
plot(summary(rqfit.f1.2005))
anova.rqs(rqfit.f1.2005, joint = FALSE)

rqfit.f1.2009 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=seq(.1,.9,.1))
summary(rqfit.f1.2009, se='boot')
plot(summary(rqfit.f1.2009))
anova.rqs(rqfit.f1.2009, joint = FALSE)

rqfit.f1.2018 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=seq(.1,.9,.1))
summary(rqfit.f1.2018, se='boot')
plot(summary(rqfit.f1.2018))
anova.rqs(rqfit.f1.2018, joint = FALSE)

```

#### Margins for Women

```{r plot rq predicted bmi women 2005, eval=TRUE, include=TRUE}

rqfit.f3.2005.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.25))

rqfit.f3.2005.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.50))

rqfit.f3.2005.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.75))

# everyone has a kid
fit.test.pred.25 <- predict(rqfit.f3.2005.25, 
                         newdata = df7[df7$survey==2005&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>% 
  cbind(df7[df7$survey==2005&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

fit.test.pred.50 <- predict(rqfit.f3.2005.50, 
                         newdata = df7[df7$survey==2005&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>% 
  cbind(df7[df7$survey==2005&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

fit.test.pred.75 <- predict(rqfit.f3.2005.75, 
                         newdata = df7[df7$survey==2005&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>% 
  cbind(df7[df7$survey==2005&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

# all three from 2005 for women

fit.test.pred.2005.f <- fit.test.pred.25 %>% rename(pred.bmic.25 = pred.bmic) %>% left_join(
  fit.test.pred.50 %>% rename(pred.bmic.50 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'num.preg.surv', 'employed')) %>% left_join(
  fit.test.pred.75 %>% rename(pred.bmic.75 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'num.preg.surv', 'employed')) %>%
  pivot_longer(cols = c(pred.bmic.25, pred.bmic.50, pred.bmic.75), names_to = 'quant', values_to = 'pred.bmic') %>%
  mutate(quant = gsub('pred.bmic.', '0.', quant))

ggplot(fit.test.pred.2005.f, aes(x = educat, y = pred.bmic, color = quant, shape = quant)) +
  geom_jitter(size=2.5) +
  stat_summary(colour = 'black') +
  scale_shape_manual(values=c(1,2,0)) +
  xlab("Education") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Education\nFemales 2005",
       caption = "Margins are based on a quantile regression adjusted for HAI, urbanicity, employment, hours of work-related 
physical exertion, and parity. HAI and parity were interacted."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2005.f, aes(x = lag.pc, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("HAI") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by HAI\nFemales 2005",
       caption = "Margins are based on a quantile regression adjusted for education, urbanicity, employment, hours of work-related 
physical exertion, and parity. HAI and parity were interacted."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2005.f, aes(x = z.lag.urb, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Urbanicity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nFemales 2005",
       caption = "Margins are based on a quantile regression adjusted for education, HAI, employment, hours of work-related 
physical exertion, and parity. HAI and parity were interacted."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

```

```{r plot rq predicted bmi women 2009, eval=TRUE, include=TRUE}

rqfit.f3.2009.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.25))

rqfit.f3.2009.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.50))

rqfit.f3.2009.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.75))

fit.test.pred.25 <- predict(rqfit.f3.2009.25, 
                         newdata = df7[df7$survey==2009&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2009&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

fit.test.pred.50 <- predict(rqfit.f3.2009.50, 
                         newdata = df7[df7$survey==2009&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2009&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

fit.test.pred.75 <- predict(rqfit.f3.2009.75, 
                         newdata = df7[df7$survey==2009&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2009&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

# all three from 2009 for women

fit.test.pred.2009.f <- fit.test.pred.25 %>% rename(pred.bmic.25 = pred.bmic) %>% left_join(
  fit.test.pred.50 %>% rename(pred.bmic.50 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'num.preg.surv', 'employed')) %>% left_join(
  fit.test.pred.75 %>% rename(pred.bmic.75 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'num.preg.surv', 'employed')) %>%
  pivot_longer(cols = c(pred.bmic.25, pred.bmic.50, pred.bmic.75), names_to = 'quant', values_to = 'pred.bmic') %>%
  mutate(quant = gsub('pred.bmic.', '0.', quant))

ggplot(fit.test.pred.2009.f, aes(x = educat, y = pred.bmic, color = quant, shape = quant)) +
  geom_jitter(size=2.5) +
  stat_summary(colour = 'black') +
  scale_shape_manual(values=c(1,2,0)) +
  xlab("Education") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Education\nFemales 2009",
  caption = "Margins are based on a quantile regression adjusted for HAI, urbanicity, employment, hours working at a non-
sedentary job, and parity. Urbanicity is a sum of scores, which represent community characteristics associated with 
urban settings."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2009.f, aes(x = lag.pc, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("HAI") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by HAI\nFemales 2009",
  caption = "Margins are based on a quantile regression adjusted for education, urbanicity, employment, hours at a non-
sedentary job, and parity. Urbanicity is a sum of scores, which represent community characteristics associated with 
urban settings."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2009.f, aes(x = z.lag.urb, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Urbanicity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nFemales 2009",
  caption = "Margins are based on a quantile regression adjusted for education, HAI, employment, hours at a non-
sedentary job, and parity. Urbanicity is a sum of scores, which represent community characteristics associated with 
urban settings."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2009.f, aes(x = num.preg.surv, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Parity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nFemales 2009",
  caption = "Margins are based on a quantile regression adjusted for education, HAI, urbanicity, employment, and hours working at a 
non-sedentary job. Urbanicity is a sum of scores, which represent community characteristics associated with urban settings."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

# summary(rqfit.f, se='nid') # nid assumes local linearity, which I believe we have (no hard corners)

```

```{r plot rq predicted bmi women 2018, eval=TRUE, include=TRUE}

rqfit.f3.2018.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.25))

rqfit.f3.2018.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.50))

rqfit.f3.2018.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed + num.preg.surv,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.75))

fit.test.pred.25 <- predict(rqfit.f3.2018.25, 
                         newdata = df7[df7$survey==2018&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2018&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

fit.test.pred.50 <- predict(rqfit.f3.2018.50, 
                         newdata = df7[df7$survey==2018&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2018&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

fit.test.pred.75 <- predict(rqfit.f3.2018.75, 
                         newdata = df7[df7$survey==2018&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2018&df7$sex==0,] %>%
                           select(educat, lag.pc, z.lag.urb, employed, num.preg.surv))

# all three from 2018 for men

fit.test.pred.2018.f <- fit.test.pred.25 %>% rename(pred.bmic.25 = pred.bmic) %>% left_join(
  fit.test.pred.50 %>% rename(pred.bmic.50 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'num.preg.surv', 'employed')) %>% left_join(
  fit.test.pred.75 %>% rename(pred.bmic.75 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'num.preg.surv', 'employed')) %>%
  pivot_longer(cols = c(pred.bmic.25, pred.bmic.50, pred.bmic.75), names_to = 'quant', values_to = 'pred.bmic') %>%
  mutate(quant = gsub('pred.bmic.', '0.', quant))

ggplot(fit.test.pred.2018.f, aes(x = educat, y = pred.bmic, color = quant, shape = quant)) +
  geom_jitter(size=2.5) +
  stat_summary(colour = 'black') +
  scale_shape_manual(values=c(1,2,0)) +
  xlab("Education") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Education\nFemales 2018",
       caption = "Margins are based on a quantile regression adjusted for HAI, urbanicity, employment, hours of work-related 
physical exertion, and parity. HAI and parity were interacted."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2018.f, aes(x = lag.pc, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("HAI") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by HAI\nFemales 2018",
       caption = "Margins are based on a quantile regression adjusted for education, urbanicity, employment, hours of work-related 
physical exertion, and parity. HAI and parity were interacted."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2018.f, aes(x = z.lag.urb, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Urbanicity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nFemales 2018",
       caption = "Margins are based on a quantile regression adjusted for education, HAI, employment, hours of work-related 
physical exertion, and parity. HAI and parity were interacted."
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

```

#### Models for men

```{r men quant reg with employment and z.exert, include=TRUE}
# men models with employment
rqfit.m2.2005 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=seq(.1,.9,.1))
summary(rqfit.m2.2005, se='boot')
plot.summary.rqs(summary(rqfit.m2.2005))
anova.rqs(rqfit.m2.2005, joint = FALSE)

rqfit.m2.2009 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=seq(.1,.9,.1))
summary(rqfit.m2.2009, se='boot')
plot.summary.rqs(summary(rqfit.m2.2009))
anova.rqs(rqfit.m2.2009, joint = FALSE)

rqfit.m2.2018 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=seq(.1,.9,.1))
summary(rqfit.m2.2018, se='boot')
plot.summary.rqs(summary(rqfit.m2.2018))
anova.rqs(rqfit.m2.2018, joint = FALSE)
```

#### Margins for men

```{r plot rq predicted bmi men 2005, eval=TRUE, include=TRUE}

rqfit.m2.2005.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(0.25))

fit.test.pred.25 <- predict(rqfit.m2.2005.25, 
                         newdata = df7[df7$survey==2005&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2005&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

rqfit.m2.2005.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(0.50))

fit.test.pred.50 <- predict(rqfit.m2.2005.50, 
                         newdata = df7[df7$survey==2005&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2005&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

rqfit.m2.2005.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(0.75))

fit.test.pred.75 <- predict(rqfit.m2.2005.75, 
                         newdata = df7[df7$survey==2005&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2005&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

# all three from 2005 for men

fit.test.pred.2005 <- fit.test.pred.25 %>% rename(pred.bmic.25 = pred.bmic) %>% left_join(
  fit.test.pred.50 %>% rename(pred.bmic.50 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'employed')) %>% left_join(
  fit.test.pred.75 %>% rename(pred.bmic.75 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'employed')) %>%
  pivot_longer(cols = c(pred.bmic.25, pred.bmic.50, pred.bmic.75), names_to = 'quant', values_to = 'pred.bmic') %>%
  mutate(quant = gsub('pred.bmic.', '0.', quant))

ggplot(fit.test.pred.2005, aes(x = educat, y = pred.bmic, color = quant, shape=quant)) +
  geom_jitter(size=2.5) +
  stat_summary(colour = 'black') +
  scale_shape_manual(values=c(1,2,0)) +
  xlab("Education") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by education\nMales 2005",
       caption = "Margins are based on a quantile regression adjusted for HAI, urbanicity, employment, and hours of work-related 
physical exertion. Education is a categorical variable, as defined earlier.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))


ggplot(fit.test.pred.2005, aes(x = lag.pc, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Household HAI") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Household HAI\nMales 2005",
       caption = "Margins are based on a quantile regression adjusted for education, urbanicity, employment, and hours of work-related 
physical exertion. HAI is represented by an index constructed from a PCA analysis of household assets.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2005, aes(x = z.lag.urb, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Urbanicity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nMales 2005",
       caption = "Margins are based on a quantile regression adjusted for HAI, education, employment, and hours of work-related 
physical exertion. Urbanicity is a sum of scores, which represent community characteristics associated with urban 
settings.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))


```

```{r plot rq predicted bmi men 2009, eval=TRUE, include=TRUE}

rqfit.m2.2009.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(0.25))

fit.test.pred.25 <- predict(rqfit.m2.2009.25, 
                         newdata = df7[df7$survey==2009&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2009&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

rqfit.m2.2009.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(0.50))

fit.test.pred.50 <- predict(rqfit.m2.2009.50, 
                         newdata = df7[df7$survey==2009&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2009&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

rqfit.m2.2009.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(0.75))

fit.test.pred.75 <- predict(rqfit.m2.2009.75, 
                         newdata = df7[df7$survey==2009&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2009&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

# all three from 2009 for men

fit.test.pred.2009 <- fit.test.pred.25 %>% rename(pred.bmic.25 = pred.bmic) %>% left_join(
  fit.test.pred.50 %>% rename(pred.bmic.50 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'employed')) %>% left_join(
  fit.test.pred.75 %>% rename(pred.bmic.75 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'employed')) %>%
  pivot_longer(cols = c(pred.bmic.25, pred.bmic.50, pred.bmic.75), names_to = 'quant', values_to = 'pred.bmic') %>%
  mutate(quant = gsub('pred.bmic.', '0.', quant))

ggplot(fit.test.pred.2005, aes(x = educat, y = pred.bmic, color = quant, shape=quant)) +
  geom_jitter(size=2.5) +
  stat_summary(colour = 'black') +
  scale_shape_manual(values=c(1,2,0)) +
  xlab("Education") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by education\nMales 2009",
       caption = "Margins are based on a quantile regression adjusted for HAI, urbanicity, employment, and hours working at a non-
sedentary job. Education is a categorical variable, as defined earlier.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))


ggplot(fit.test.pred.2009, aes(x = lag.pc, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Household HAI") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Household HAI\nMales 2009",
       caption = "Margins are based on a quantile regression adjusted for education, urbanicity, employment, and hours working at a non-
sedentary job. HAI is represented by an index constructed from a PCA analysis of household assets.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

ggplot(fit.test.pred.2009, aes(x = z.lag.urb, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Urbanicity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nMales 2009",
       caption = "Margins are based on a quantile regression adjusted for HAI, education, employment, and hours working at a non-
sedentary job. Urbanicity is a sum of scores, which represent community characteristics associated with urban settings.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

```

```{r plot rq predicted bmi men 2018, eval=TRUE, include=TRUE}

rqfit.m2.2018.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(0.25))

fit.test.pred.25 <- predict(rqfit.m2.2018.25, 
                         newdata = df7[df7$survey==2018&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2018&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

rqfit.m2.2018.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(0.50))

fit.test.pred.50 <- predict(rqfit.m2.2018.50, 
                         newdata = df7[df7$survey==2018&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2018&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

rqfit.m2.2018.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(0.75))

fit.test.pred.75 <- predict(rqfit.m2.2018.75, 
                         newdata = df7[df7$survey==2018&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed)) %>% as.data.frame() %>% rename(pred.bmic = 1) %>%
  cbind(df7[df7$survey==2018&df7$sex==1,] %>%
                           select(educat, lag.pc, z.lag.urb, employed))

# all three from 2018 for men

fit.test.pred.2018 <- fit.test.pred.25 %>% rename(pred.bmic.25 = pred.bmic) %>% left_join(
  fit.test.pred.50 %>% rename(pred.bmic.50 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'employed')) %>% left_join(
  fit.test.pred.75 %>% rename(pred.bmic.75 = pred.bmic), by = c('educat', 'lag.pc', 'z.lag.urb', 'employed')) %>%
  pivot_longer(cols = c(pred.bmic.25, pred.bmic.50, pred.bmic.75), names_to = 'quant', values_to = 'pred.bmic') %>%
  mutate(quant = gsub('pred.bmic.', '0.', quant))

ggplot(fit.test.pred.2018 %>%
         mutate(educat = factor(educat, levels=c(1,2,3,4), labels=c('Less than HS', 'HS', 'Some College', 'College'))), 
       aes(x = educat, y = pred.bmic, color = quant, shape=quant)) +
  geom_jitter(size=2.5) +
  stat_summary(colour = 'black') +
  scale_shape_manual(values=c(1,2,0)) +
  xlab("Educational Attainment") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by education\nMales 2018",
       caption = "Margins are based on a quantile regression adjusted for HAI, urbanicity, employment, and hours of work-related 
physical exertion. Education is a categorical variable, as defined earlier.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))


ggplot(fit.test.pred.2018, aes(x = lag.pc, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant), position=position_jitterdodge(jitter.width=0.6)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Household HAI") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Household HAI\nMales 2018",
       caption = "Margins are based on a quantile regression adjusted for education, urbanicity, employment, and hours of work-related 
physical exertion. HAI is represented by an index constructed from a PCA analysis of household assets.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile")) +
  xlim(-2, 2.8)

ggplot(fit.test.pred.2018, aes(x = z.lag.urb, y = pred.bmic, color = quant)) +
  geom_point(size=2.5, aes(shape=quant)) +
  scale_shape_manual(values=c(1,2,0)) +
  geom_smooth() +
  xlab("Urbanicity") +
  ylab("Predicted BMI") +
  labs(title = "Predictive Margins of BMI by Urbanicity\nMales 2018",
       caption = "Margins are based on a quantile regression adjusted for HAI, education, employment, and hours of work-related 
physical exertion. Urbanicity is a sum of scores, which represent community characteristics associated with urban 
settings.",
) +
  theme(plot.caption.position = "panel", plot.caption = element_text(hjust = 0)) +
  guides(col=guide_legend(title="Quantile"),
         shape=guide_legend(title="Quantile"))

```

### Illustrating quantile regression {.tabset .tabset-fade .tabset-pills}
```{r plot qreg, eval=TRUE, include=TRUE}

ggplot(data = df7[df7$sex==0 & df7$survey==2018,], aes(x = lag.urbindex, y = bmic)) +
  geom_point() +
  geom_smooth(method = lm, se = FALSE, color = "red", size = 0.9) + # linear model
  geom_quantile(color = "darkorange", quantiles = 0.05, linetype = 'dashed', size=1.2) +
  geom_quantile(color = "salmon", quantiles = 0.25, linetype = 'dashed', size=1.2) +
  geom_quantile(color = "forestgreen", quantiles = 0.5, linetype = 'dashed', size=1.2) +
  geom_quantile(color = "blue", quantiles = 0.75, linetype = 'dashed', size=1.2) +
  geom_quantile(color = "steelblue", quantiles = 0.95, linetype = 'dashed', size=1.2) +
  labs(x="Urbanicity Index", y = "BMI", title = "Female BMI in 2018",
       caption = "Quantile regression compared to OLS. Note the robustness of quantile regression to outliers.")


```

### Main table with results from the models (men and women all years) lagged {.tabset .tabset-fade .tabset-pills}

#### 2005

```{r putting the results into a table 2005, results='asis', eval=TRUE, include=TRUE}

# with pc*preg interaction
rqf05.25 <- rq(bmic ~ educat + lag.pc*num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.25))

rqf05.50 <- rq(bmic ~ educat + lag.pc*num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.5))

rqf05.75 <- rq(bmic ~ educat + lag.pc*num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.75))

rqm05.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(.25))
rqm05.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(.5))
rqm05.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(.75))

stargazer(rqf05.25, rqf05.50, rqf05.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2005</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Work-related exertion', 'HAI:Parity', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

stargazer(rqm05.25, rqm05.50, rqm05.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2005</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Work-related exertion', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

plot_summs(rqf05.75, rqf05.50, rqf05.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv', 'Parity*HAI' = 'lag.pc:num.preg.surv')) + 
  labs(title = 'Females Quantile Regression Output Coefficients (2005)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm05.75, rqm05.50, rqm05.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output Coefficients (2005)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)


```

#### 2009

```{r putting the results into a table 2009, results='asis', eval=TRUE, include=TRUE}

rqf09.25 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.25))

rqf09.50 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.5))

rqf09.75 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.75))

rqm09.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(.25))
rqm09.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(.5))
rqm09.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(.75))

stargazer(rqf09.25, rqf09.50, rqf09.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2009</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Non-sedentary work', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

stargazer(rqm09.25, rqm09.50, rqm09.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2009</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Non-sedentary work', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

# plotting estimates
plot_summs(rqf09.75, rqf09.50, rqf09.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv')) + 
  labs(title = 'Females Quantile Regression Output coefficients (2009)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm09.75, rqm09.50, rqm09.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output coefficients (2009)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

```

#### 2018

```{r putting the results into a table 2018, results='asis', eval=TRUE, include=TRUE}

rqf18.25 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.25))
rqf18.50 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.5))
rqf18.75 <- rq(bmic ~ educat + lag.pc + num.preg.surv + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.75))

rqm18.25 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(.25))
rqm18.50 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(.5))
rqm18.75 <- rq(bmic ~ educat + lag.pc + z.lag.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(.75))

# generate stargazer output
stargazer(rqf18.25, rqf18.50, rqf18.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2018</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Work-related exertion', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

stargazer(rqm18.25, rqm18.50, rqm18.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2018</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Work-related exertion', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

# now plot coefficients
plot_summs(rqf18.75, rqf18.50, rqf18.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv')) +
  labs(title = 'Females Quantile Regression Output coefficients (2018)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm18.75, rqm18.50, rqm18.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output coefficients (2018)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

```

#### Only rel plots for all years

```{r final coeff tables, include=TRUE}
# women
summ(rqf05.25, confint = TRUE, digits = 3)
summ(rqf05.50, confint = TRUE, digits = 3)
summ(rqf05.75, confint = TRUE, digits = 3)

summ(rqf09.25, confint = TRUE, digits = 3)
summ(rqf09.50, confint = TRUE, digits = 3)
summ(rqf09.75, confint = TRUE, digits = 3)

summ(rqf18.25, confint = TRUE, digits = 3)
summ(rqf18.50, confint = TRUE, digits = 3)
summ(rqf18.75, confint = TRUE, digits = 3)

# men
summ(rqm05.25, confint = TRUE, digits = 3)
summ(rqm05.50, confint = TRUE, digits = 3)
summ(rqm05.75, confint = TRUE, digits = 3)

summ(rqm09.25, confint = TRUE, digits = 3)
summ(rqm09.50, confint = TRUE, digits = 3)
summ(rqm09.75, confint = TRUE, digits = 3)

summ(rqm18.25, confint = TRUE, digits = 3)
summ(rqm18.50, confint = TRUE, digits = 3)
summ(rqm18.75, confint = TRUE, digits = 3)

```

```{r make plots for final coeff tables, include=TRUE}

pm05 <- plot_summs(rqm05.75, rqm05.50, rqm05.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb')) + 
  labs(title = 'Males: 2005') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pm09 <- plot_summs(rqm09.75, rqm09.50, rqm09.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb')) + 
  labs(title = '2009') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pm18 <- plot_summs(rqm18.75, rqm18.50, rqm18.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb')) + 
  labs(title = '2018') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

pf05 <- plot_summs(rqf05.75, rqf05.50, rqf05.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb', 'Parity' = 'num.preg.surv', 'Parity*HAI' = 'lag.pc:num.preg.surv')) + 
  labs(title = 'Females: 2005') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pf09 <- plot_summs(rqf09.75, rqf09.50, rqf09.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1', 'num.preg.surv'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb')) + 
  labs(title = '2009') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5.5,5) + theme(legend.position = "none")

pf18 <- plot_summs(rqf18.75, rqf18.50, rqf18.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1', 'num.preg.surv'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'lag.pc', 'Urbanicity\nIndex' = 'z.lag.urb')) + 
  labs(title = '2018') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)


```

```{r put together main table no controlled, results='asis', include=TRUE, echo=FALSE, fig.width=12, fig.height=9}

grid.arrange(pf05, pf09, pf18, pm05, pm09, pm18, ncol=3, nrow=2, widths = c(3,3,3.87))

```

### ANOVA comparison of quantile coefficients lagged

Here, I am putting together the coefficients for comparing the different quantiles into a table
I am doing separate comparisons for quantiles by sex and year (comparing coefficients themselves) and then separate comparisons for men. There, I cannot test just the coefficients, since the variables were somewhat different, but I can test the difference in the model as a whole - separately for each quantile, and report the F test results
```{r ANOVA quantile reg initial tables, eval=TRUE, include=FALSE}

# ANOVA to compare the coefficients from different quantiles

# female
rqcomp05f.2550 <- anova(rqf05.25, rqf05.50, joint=FALSE)
rqcomp05f.5075 <- anova(rqf05.50, rqf05.75, joint=FALSE)
rqcomp05f.2575 <- anova(rqf05.25, rqf05.75, joint=FALSE)

# male
rqcomp05m.2550 <- anova(rqm05.25, rqm05.50, joint=FALSE)
rqcomp05m.5075 <- anova(rqm05.50, rqm05.75, joint=FALSE)
rqcomp05m.2575 <- anova(rqm05.25, rqm05.75, joint=FALSE)

# female
rqcomp09f.2550 <- anova(rqf09.25, rqf09.50, joint=FALSE)
rqcomp09f.5075 <- anova(rqf09.50, rqf09.75, joint=FALSE)
rqcomp09f.2575 <- anova(rqf09.25, rqf09.75, joint=FALSE)

# male
rqcomp09m.2550 <- anova(rqm09.25, rqm09.50, joint=FALSE)
rqcomp09m.5075 <- anova(rqm09.50, rqm09.75, joint=FALSE)
rqcomp09m.2575 <- anova(rqm09.25, rqm09.75, joint=FALSE)

# female
rqcomp18f.2550 <- anova(rqf18.25, rqf18.50, joint=FALSE)
rqcomp18f.5075 <- anova(rqf18.50, rqf18.75, joint=FALSE)
rqcomp18f.2575 <- anova(rqf18.25, rqf18.75, joint=FALSE)

# male
rqcomp18m.2550 <- anova(rqm18.25, rqm18.50, joint=FALSE)
rqcomp18m.5075 <- anova(rqm18.50, rqm18.75, joint=FALSE)
rqcomp18m.2575 <- anova(rqm18.25, rqm18.75, joint=FALSE)

```

```{r ANOVA tbl making func, eval=TRUE, include=FALSE}

# function to make it simpler
makeqtbl <- function(sex, year, var) {
  df.2550 <- eval(parse(text = paste0('rqcomp', year, sex, '.2550')))
  df.5075 <- eval(parse(text = paste0('rqcomp', year, sex, '.5075')))
  df.2575 <- eval(parse(text = paste0('rqcomp', year, sex, '.2575')))
  
  comp1 <- ifelse(df.2550$table[var,4] < 0.05,
                 paste0(sprintf('%.1f', df.2550$table[var,3]),'* (p = ', sprintf('%.2f', df.2550$table[var,4]),')'),
                 paste0(sprintf('%.1f', df.2550$table[var,3]),' (p = ', sprintf('%.2f', df.2550$table[var,4]),')'))
  
  comp2 <- ifelse(df.5075$table[var,4] < 0.05,
                 paste0(sprintf('%.1f', df.5075$table[var,3]),'* (p = ', sprintf('%.2f', df.5075$table[var,4]),')'),
                 paste0(sprintf('%.1f', df.5075$table[var,3]),' (p = ', sprintf('%.2f', df.5075$table[var,4]),')'))
  
  comp3 <- ifelse(df.2575$table[var,4] < 0.05,
                 paste0(sprintf('%.1f', df.2575$table[var,3]),'* (p = ', sprintf('%.2f', df.2575$table[var,4]),')'),
                 paste0(sprintf('%.1f', df.2575$table[var,3]),' (p = ', sprintf('%.2f', df.2575$table[var,4]),')'))
  
  row1 <- c('0.25', '--', comp1, comp3)
  row2 <- c('0.50', comp1, '--', comp2)
  row3 <- c('0.75', comp3, comp2, '--')
  
  out <- rbind(row1, row2, row3) %>% as.data.frame()
  colnames(out) <- c('Q', '0.25', '0.50', '0.75')
  
  return(out)
}
```

```{r putting ANOVA coeffs into tables by var, include=TRUE}

# female 2005
rq.comp.05f <- rbind(
  makeqtbl('f','05','educat2'),
  makeqtbl('f','05','educat3'),
  makeqtbl('f','05','educat4'),
  makeqtbl('f','05','lag.pc'),
  makeqtbl('f','05','z.lag.urb'),
  makeqtbl('f','05','employed'),
  makeqtbl('f','05','num.preg.surv'),
  makeqtbl('f','05','z.exert'),
  makeqtbl('f','05','lag.pc:num.preg.surv')
) %>% mutate(Var = c('', 'HS Grad', '', '', 'Some College', '', '', 'College Grad', '', '', 'HAI', '', '', 'Urbanicity', '', '', 'Employed', '', '', 'Parity', '', '', 'Work-related exertion', '', '', 'HAI:Parity', '')) %>% select('Var', 'Q', '0.25','0.50', '0.75') %>% rename('Variables'='Var', 'Quantiles'='Q')

# male 2005
rq.comp.05m <- rbind(
  makeqtbl('m','05','educat2'),
  makeqtbl('m','05','educat3'),
  makeqtbl('m','05','educat4'),
  makeqtbl('m','05','lag.pc'),
  makeqtbl('m','05','z.lag.urb'),
  makeqtbl('m','05','employed'),
  makeqtbl('m','05','z.exert')) %>% mutate(Var = c('', 'HS Grad', '', '', 'Some College', '', '', 'College Grad', '', '', 'HAI', '', '', 'Urbanicity', '', '', 'Employed', '', '', 'Work-related exertion', '')) %>% select('Var', 'Q', '0.25','0.50', '0.75') %>% rename('Variables'='Var', 'Quantiles'='Q')

# female 2009
rq.comp.09f <- rbind(
  makeqtbl('f','09','educat2'),
  makeqtbl('f','09','educat3'),
  makeqtbl('f','09','educat4'),
  makeqtbl('f','09','lag.pc'),
  makeqtbl('f','09','z.lag.urb'),
  makeqtbl('f','09','employed'),
  makeqtbl('f','09','num.preg.surv'),
  makeqtbl('f','09','z.exert')
) %>% mutate(Var = c('', 'HS Grad', '', '', 'Some College', '', '', 'College Grad', '', '', 'HAI', '', '', 'Urbanicity', '', '', 'Employed', '', '', 'Parity', '', '', 'Non-sedentary work', '')) %>% select('Var', 'Q', '0.25','0.50', '0.75') %>% rename('Variables'='Var', 'Quantiles'='Q')

# male 2009
rq.comp.09m <- rbind(
  makeqtbl('m','09','educat2'),
  makeqtbl('m','09','educat3'),
  makeqtbl('m','09','educat4'),
  makeqtbl('m','09','lag.pc'),
  makeqtbl('m','09','z.lag.urb'),
  makeqtbl('m','09','employed'),
  makeqtbl('m','09','z.exert')) %>% mutate(Var = c('', 'HS Grad', '', '', 'Some College', '', '', 'College Grad', '', '', 'HAI', '', '', 'Urbanicity', '', '', 'Employed', '', '', 'Non-sedentary work', '')) %>% select('Var', 'Q', '0.25','0.50', '0.75') %>% rename('Variables'='Var', 'Quantiles'='Q')

# female 2018
rq.comp.18f <- rbind(
  makeqtbl('f','18','educat2'),
  makeqtbl('f','18','educat3'),
  makeqtbl('f','18','educat4'),
  makeqtbl('f','18','lag.pc'),
  makeqtbl('f','18','z.lag.urb'),
  makeqtbl('f','18','employed'),
  makeqtbl('f','18','num.preg.surv'),
  makeqtbl('f','18','z.exert')
) %>% mutate(Var = c('', 'HS Grad', '', '', 'Some College', '', '', 'College Grad', '', '', 'HAI', '', '', 'Urbanicity', '', '', 'Employed', '', '', 'Parity', '', '', 'Work-related exertion', '')) %>% select('Var', 'Q', '0.25','0.50', '0.75') %>% rename('Variables'='Var', 'Quantiles'='Q')

# male 2018
rq.comp.18m <- rbind(
  makeqtbl('m','18','educat2'),
  makeqtbl('m','18','educat3'),
  makeqtbl('m','18','educat4'),
  makeqtbl('m','18','lag.pc'),
  makeqtbl('m','18','z.lag.urb'),
  makeqtbl('m','18','employed'),
  makeqtbl('m','18','z.exert')) %>% mutate(Var = c('', 'HS Grad', '', '', 'Some College', '', '', 'College Grad', '', '', 'HAI', '', '', 'Urbanicity', '', '', 'Employed', '', '', 'Work-related exertion', '')) %>% select('Var', 'Q', '0.25','0.50', '0.75') %>% rename('Variables'='Var', 'Quantiles'='Q')

# female kable output 2005
kable(rq.comp.05f, row.names = FALSE, align='rcccc', 
      caption='<b>ANOVA Comparison of Coefficient Estimates from<br>Quantile Regression on BMI</b><br>Females 2005') %>%
  column_spec(1, width = '5cm', bold=TRUE) %>%
  column_spec(2, width = '2cm', bold=TRUE) %>%
  column_spec(3:5, width = '3.5cm') %>%
  kableExtra::row_spec(seq(3, nrow(rq.comp.05f), 3), extra_css = "border-bottom: 1px solid;")

# male kable output 2005
kable(rq.comp.05m, row.names = FALSE, align='rcccc', 
      caption='Males 2005') %>%
  column_spec(1, width = '5cm', bold=TRUE) %>%
  column_spec(2, width = '2cm', bold=TRUE) %>%
  column_spec(3:5, width = '3.5cm') %>%
  kableExtra::row_spec(seq(3, nrow(rq.comp.05m), 3), extra_css = "border-bottom: 1px solid;")

# female kable output 2009
kable(rq.comp.09f, row.names = FALSE, align='rcccc', 
      caption='Females 2009') %>%
  column_spec(1, width = '5cm', bold=TRUE) %>%
  column_spec(2, width = '2cm', bold=TRUE) %>%
  column_spec(3:5, width = '3.5cm') %>%
  kableExtra::row_spec(seq(3, nrow(rq.comp.09f), 3), extra_css = "border-bottom: 1px solid;")

# male kable output 2009
kable(rq.comp.09m, row.names = FALSE, align='rcccc', 
      caption='Males 2009') %>%
  column_spec(1, width = '5cm', bold=TRUE) %>%
  column_spec(2, width = '2cm', bold=TRUE) %>%
  column_spec(3:5, width = '3.5cm') %>%
  kableExtra::row_spec(seq(3, nrow(rq.comp.09m), 3), extra_css = "border-bottom: 1px solid;")

# female kable output 2018
kable(rq.comp.18f, row.names = FALSE, align='rcccc', 
      caption='Females 2018') %>%
  column_spec(1, width = '5cm', bold=TRUE) %>%
  column_spec(2, width = '2cm', bold=TRUE) %>%
  column_spec(3:5, width = '3.5cm') %>%
  kableExtra::row_spec(seq(3, nrow(rq.comp.18f), 3), extra_css = "border-bottom: 1px solid;")

# male kable output 2018
kable(rq.comp.18m, row.names = FALSE, align='rcccc', 
      caption='Males 2018') %>%
  column_spec(1, width = '5cm', bold=TRUE) %>%
  column_spec(2, width = '2cm', bold=TRUE) %>%
  column_spec(3:5, width = '3.5cm') %>%
  kableExtra::row_spec(seq(3, nrow(rq.comp.18m), 3), extra_css = "border-bottom: 1px solid;")


```

### Main table with results from the models (men and women all years) concurrent {.tabset .tabset-fade .tabset-pills}

#### 2005

```{r putting nl results into a table 2005, results='asis', eval=TRUE, include=TRUE}

df7 <- df7 %>% group_by(survey) %>%
  mutate(z.urb = (urbindex - mean(urbindex, na.rm=TRUE))/sd(urbindex, na.rm=TRUE)) %>%
  ungroup()

# with pc*preg interaction
rqf05.25. <- rq(bmic ~ educat + pc*num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.25))

rqf05.50. <- rq(bmic ~ educat + pc*num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.5))

rqf05.75. <- rq(bmic ~ educat + pc*num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2005&df7$sex==0,], tau=c(.75))

rqm05.25. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(.25))
rqm05.50. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(.5))
rqm05.75. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2005&df7$sex==1,], tau=c(.75))

stargazer(rqf05.25., rqf05.50., rqf05.75., 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2005</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'HAI:Parity', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

stargazer(rqm05.25., rqm05.50., rqm05.75., 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2005</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

plot_summs(rqf05.75., rqf05.50., rqf05.25., robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv', 'Parity*HAI' = 'pc:num.preg.surv')) + 
  labs(title = 'Females Quantile Regression Output Coefficients (2005)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm05.75., rqm05.50., rqm05.25., robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output Coefficients (2005)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)


```

#### 2009

```{r putting nl results into a table 2009, results='asis', eval=TRUE, include=TRUE}

rqf09.25. <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.25))

rqf09.50. <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.5))

rqf09.75. <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2009&df7$sex==0,], tau=c(.75))

rqm09.25. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(.25))
rqm09.50. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(.5))
rqm09.75. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2009&df7$sex==1,], tau=c(.75))

stargazer(rqf09.25., rqf09.50., rqf09.75., 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2009</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

stargazer(rqm09.25., rqm09.50., rqm09.75., 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2009</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

# plotting estimates
plot_summs(rqf09.75., rqf09.50., rqf09.25., robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv')) + 
  labs(title = 'Females Quantile Regression Output coefficients (2009)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm09.75., rqm09.50., rqm09.25., robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output coefficients (2009)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

```

#### 2018

```{r putting nl results into a table 2018, results='asis', eval=TRUE, include=TRUE}

rqf18.25. <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.25))
rqf18.50. <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.5))
rqf18.75. <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df7[df7$survey==2018&df7$sex==0,], tau=c(.75))

rqm18.25. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(.25))
rqm18.50. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(.5))
rqm18.75. <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df7[df7$survey==2018&df7$sex==1,], tau=c(.75))

# generate stargazer output
stargazer(rqf18.25., rqf18.50., rqf18.75., 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2018</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

stargazer(rqm18.25., rqm18.50., rqm18.75., 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2018</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2018.doc')

# now plot coefficients
plot_summs(rqf18.75., rqf18.50., rqf18.25., robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv')) +
  labs(title = 'Females Quantile Regression Output coefficients (2018)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm18.75., rqm18.50., rqm18.25., robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output coefficients (2018)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

```

#### Only rel plots for all years

```{r final coeff tables nl, include=TRUE}
# women
summ(rqf05.25., confint = TRUE, digits = 3)
summ(rqf05.50., confint = TRUE, digits = 3)
summ(rqf05.75., confint = TRUE, digits = 3)

summ(rqf09.25., confint = TRUE, digits = 3)
summ(rqf09.50., confint = TRUE, digits = 3)
summ(rqf09.75., confint = TRUE, digits = 3)

summ(rqf18.25., confint = TRUE, digits = 3)
summ(rqf18.50., confint = TRUE, digits = 3)
summ(rqf18.75., confint = TRUE, digits = 3)

# men
summ(rqm05.25., confint = TRUE, digits = 3)
summ(rqm05.50., confint = TRUE, digits = 3)
summ(rqm05.75., confint = TRUE, digits = 3)

summ(rqm09.25., confint = TRUE, digits = 3)
summ(rqm09.50., confint = TRUE, digits = 3)
summ(rqm09.75., confint = TRUE, digits = 3)

summ(rqm18.25., confint = TRUE, digits = 3)
summ(rqm18.50., confint = TRUE, digits = 3)
summ(rqm18.75., confint = TRUE, digits = 3)

```

```{r make plots for final coeff tables nl, include=TRUE}

pm05. <- plot_summs(rqm05.75., rqm05.50., rqm05.25., robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = 'Males: 2005') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pm09. <- plot_summs(rqm09.75., rqm09.50., rqm09.25., robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2009') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pm18. <- plot_summs(rqm18.75., rqm18.50., rqm18.25., robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2018') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

pf05. <- plot_summs(rqf05.75., rqf05.50., rqf05.25., robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Parity' = 'num.preg.surv', 'Parity*HAI' = 'pc:num.preg.surv')) + 
  labs(title = 'Females: 2005') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pf09. <- plot_summs(rqf09.75., rqf09.50., rqf09.25., robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1', 'num.preg.surv'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2009') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5.5,5) + theme(legend.position = "none")

pf18. <- plot_summs(rqf18.75., rqf18.50., rqf18.25., robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1', 'num.preg.surv'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2018') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)


  # xlim(-0.17,0.17) + theme(legend.position = "none") +
  # font("title", size = 12, face = "bold") +
  # font("xlab", size = 10) +
  # font("xy.text", size = 10, color = "gray40", face = "bold.italic")

```

```{r put together main table no controlled nl, results='asis', include=TRUE, echo=FALSE, fig.width=12, fig.height=9}

grid.arrange(pf05., pf09., pf18., pm05., pm09., pm18., ncol=3, nrow=2, widths = c(3,3,3.87))

```

### Repeating analyses with only 2018 sample {.tabset .tabset-fade .tabset-pills}

To test for bias due to attrition, I will re-run the analyses for 2009 and 2005 using only people who remained in the 2018 sample.

#### 2005

```{r putting comp 2018 results into a table 2005, results='asis', eval=TRUE, include=TRUE}

id.2018 <- unique(df7[df7$survey==2018,]$uncchdid)
df9 <- df7 %>% filter(uncchdid %in% id.2018)

# with pc*preg interaction
rqf05.25 <- rq(bmic ~ educat + pc*num.preg.surv + z.urb + employed,
            data=df9[df9$survey==2005&df9$sex==0,], tau=c(.25))

rqf05.50 <- rq(bmic ~ educat + pc*num.preg.surv + z.urb + employed,
            data=df9[df9$survey==2005&df9$sex==0,], tau=c(.5))

rqf05.75 <- rq(bmic ~ educat + pc*num.preg.surv + z.urb + employed,
            data=df9[df9$survey==2005&df9$sex==0,], tau=c(.75))

rqm05.25 <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df9[df9$survey==2005&df9$sex==1,], tau=c(.25))
rqm05.50 <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df9[df9$survey==2005&df9$sex==1,], tau=c(.5))
rqm05.75 <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df9[df9$survey==2005&df9$sex==1,], tau=c(.75))

stargazer(rqf05.25, rqf05.50, rqf05.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2005</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Work-related exertion', 'HAI:Parity', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

stargazer(rqm05.25, rqm05.50, rqm05.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2005</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Work-related exertion', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2005.doc')

plot_summs(rqf05.75, rqf05.50, rqf05.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv', 'Parity*HAI' = 'pc:num.preg.surv')) + 
  labs(title = 'Females Quantile Regression Output Coefficients (2005)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm05.75, rqm05.50, rqm05.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output Coefficients (2005)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)


```

#### 2009

```{r putting comp 2018 results into a table 2009, results='asis', eval=TRUE, include=TRUE}

rqf09.25 <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df9[df9$survey==2009&df9$sex==0,], tau=c(.25))

rqf09.50 <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df9[df9$survey==2009&df9$sex==0,], tau=c(.5))

rqf09.75 <- rq(bmic ~ educat + pc + num.preg.surv + z.urb + employed,
            data=df9[df9$survey==2009&df9$sex==0,], tau=c(.75))

rqm09.25 <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df9[df9$survey==2009&df9$sex==1,], tau=c(.25))
rqm09.50 <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df9[df9$survey==2009&df9$sex==1,], tau=c(.5))
rqm09.75 <- rq(bmic ~ educat + pc + z.urb + employed,
            data=df9[df9$survey==2009&df9$sex==1,], tau=c(.75))

stargazer(rqf09.25, rqf09.50, rqf09.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2009</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Female ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Parity', 'Urbanicity index', 'Employment', 'Non-sedentary work', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

stargazer(rqm09.25, rqm09.50, rqm09.75, 
          type='html',
          digits = 3, 
          title = 'Coefficient Estimates from a Quantile Regression on BMI by Year', 
          dep.var.caption = '<b>2009</b>',
          style = 'default', 
          column.labels = c('<b>Quantile<br>0.25</b>', '<b>Quantile<br>0.50<b/>', '<b>Quantile<br>0.75</b>'), 
          dep.var.labels = 'Male ICs', 
          report="vc*sp", star.cutoffs=c(0.05, 0.01, 0.001), 
          ci=T, 
          covariate.labels = c('HS Grad', 'Some College', 'College Grad', 'HAI', 'Urbanicity index', 'Employment', 'Non-sedentary work', 'Constant'),
          notes = '***p<0.05;** p<0.01; p<0.001*', notes.append=FALSE,
          digits.extra = 0,
          out = 'tab2009.doc')

# plotting estimates
plot_summs(rqf09.75, rqf09.50, rqf09.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1', 'Parity' = 'num.preg.surv')) + 
  labs(title = 'Females Quantile Regression Output coefficients (2009)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

plot_summs(rqm09.75, rqm09.50, rqm09.25, robust = list(FALSE, "0.50", "0.25"),
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Employed' = 'employed1')) + 
  labs(title = 'Males Quantile Regression Output coefficients (2009)') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

```

#### Only rel plots for all years

```{r final coeff tables comp 2018, include=TRUE}
# women
summ(rqf05.25, confint = TRUE, digits = 3)
summ(rqf05.50, confint = TRUE, digits = 3)
summ(rqf05.75, confint = TRUE, digits = 3)

summ(rqf09.25, confint = TRUE, digits = 3)
summ(rqf09.50, confint = TRUE, digits = 3)
summ(rqf09.75, confint = TRUE, digits = 3)

summ(rqf18.25, confint = TRUE, digits = 3)
summ(rqf18.50, confint = TRUE, digits = 3)
summ(rqf18.75, confint = TRUE, digits = 3)

# men
summ(rqm05.25, confint = TRUE, digits = 3)
summ(rqm05.50, confint = TRUE, digits = 3)
summ(rqm05.75, confint = TRUE, digits = 3)

summ(rqm09.25, confint = TRUE, digits = 3)
summ(rqm09.50, confint = TRUE, digits = 3)
summ(rqm09.75, confint = TRUE, digits = 3)

summ(rqm18.25, confint = TRUE, digits = 3)
summ(rqm18.50, confint = TRUE, digits = 3)
summ(rqm18.75, confint = TRUE, digits = 3)

```

```{r make plots for final coeff tables comp 2018, include=TRUE}

pm05 <- plot_summs(rqm05.75, rqm05.50, rqm05.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = 'Males: 2005') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pm09 <- plot_summs(rqm09.75, rqm09.50, rqm09.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2009') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pm18 <- plot_summs(rqm18.75, rqm18.50, rqm18.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2018') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

pf05 <- plot_summs(rqf05.75, rqf05.50, rqf05.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb', 'Parity' = 'num.preg.surv', 'Parity*HAI' = 'pc:num.preg.surv')) + 
  labs(title = 'Females: 2005') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5) + theme(legend.position = "none")

pf09 <- plot_summs(rqf09.75, rqf09.50, rqf09.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1', 'num.preg.surv'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2009') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5.5,5) + theme(legend.position = "none")

pf18 <- plot_summs(rqf18.75, rqf18.50, rqf18.25, robust = TRUE,
           model.names = c("0.75", "0.50", "0.25"),
           point.size = 6,
           omit.coefs = c('employed1', 'num.preg.surv'),
           coefs = c("HS Grad" = 'educat2', "Some College" = 'educat3', "College Grad" = 'educat4', 'HAI' = 'pc', 'Urbanicity\nIndex' = 'z.urb')) + 
  labs(title = '2018') +
  scale_shape_discrete(name = "Quantile") +
  scale_color_discrete(name = "Quantile") +
  xlim(-5,5)

```

```{r put together main table comp 2018, results='asis', include=TRUE, echo=FALSE, fig.width=12, fig.height=9}

grid.arrange(pf05, pf09, pf18, pm05, pm09, pm18, ncol=3, nrow=2, widths = c(3,3,3.87))

```

